<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="LZ">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/18/professional_courses/jizu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LZ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/18/professional_courses/jizu/" class="post-title-link" itemprop="url">JiZu</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-18 23:42:36" itemprop="dateCreated datePublished" datetime="2021-10-18T23:42:36+08:00">2021-10-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-10-25 22:57:27" itemprop="dateModified" datetime="2021-10-25T22:57:27+08:00">2021-10-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Professional-Courses/" itemprop="url" rel="index"><span itemprop="name">Professional Courses</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="第一章概述"><a href="#第一章概述" class="headerlink" title="第一章概述"></a>第一章概述</h1><h2 id="冯诺依曼结构计算机工作原理及层次结构分析"><a href="#冯诺依曼结构计算机工作原理及层次结构分析" class="headerlink" title="冯诺依曼结构计算机工作原理及层次结构分析"></a>冯诺依曼结构计算机工作原理及层次结构分析</h2><p><strong>冯诺依曼计算机的工作原理：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211019231620.png" alt="image-20211019231613656"></p>
<p><strong>冯诺依曼计算机组成</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211019231721.png" alt="image-20211019231721820"></p>
<p>1）硬件系统-<strong>运算器</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211019231832.png" alt="image-20211019231832297"></p>
<p>硬件系统-<strong>控制器</strong></p>
<p>硬件系统-<strong>存储器</strong></p>
<ul>
<li><p>功能：存储原程序、原数据、运算中间结果</p>
</li>
<li><p>工作原理：按地址访问，读/写数据</p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211019232146.png" alt="image-20211019232146220"></p>
</li>
</ul>
<p>硬件系统-<strong>输入输出设备</strong></p>
<p>2）软件系统：</p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211019232319.png" alt="image-20211019232319122"></p>
<p>3）硬件与软件系统间的关系</p>
<ul>
<li>相互依存</li>
<li>逻辑等效性</li>
<li>协同发展</li>
</ul>
<p><strong>计算机的层级结构</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211019232511.png" alt="image-20211019232511401"></p>
<ul>
<li>不同用户处在不同的层次</li>
<li>不同层次具有不同的属性</li>
<li>不同层次使用不同的工具</li>
<li>不同层次代码效率不同</li>
</ul>
<p><strong>透明性概念</strong></p>
<p><strong>系统观</strong></p>
<p><strong>编程的CPU硬件相关性</strong></p>
<p><strong>软硬件的分界线：</strong></p>
<p>​    指令集架构层</p>
<h2 id="计算机系统性能的评价"><a href="#计算机系统性能的评价" class="headerlink" title="计算机系统性能的评价"></a>计算机系统性能的评价</h2><h3 id="1-非时间指标："><a href="#1-非时间指标：" class="headerlink" title="1 非时间指标："></a>1 非时间指标：</h3><h4 id="1）机器字长：指机器一次能处理的二进制数"><a href="#1）机器字长：指机器一次能处理的二进制数" class="headerlink" title="1）机器字长：指机器一次能处理的二进制数"></a>1）机器字长：指机器一次能处理的二进制数</h4><ul>
<li>由加法器、寄存器的位数决定</li>
<li>一般与内部寄存器的位数相等</li>
<li>字长越长，表示数据的范围就越大，精确度越高</li>
<li>常见的有32位和64位</li>
</ul>
<h4 id="2）-总线宽度：数据总线一次能并行传送的最大信息位数"><a href="#2）-总线宽度：数据总线一次能并行传送的最大信息位数" class="headerlink" title="2） 总线宽度：数据总线一次能并行传送的最大信息位数"></a>2） 总线宽度：数据总线一次能并行传送的最大信息位数</h4><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211019233422.png" alt="image-20211019233422332"></p>
<h4 id="3）-主存容量与存储带宽"><a href="#3）-主存容量与存储带宽" class="headerlink" title="3） 主存容量与存储带宽"></a>3） 主存容量与存储带宽</h4><ul>
<li>主存容量：一台计算机主存所包含的存储单元总数</li>
<li>单位时间内与主存交换的二机制信息量B/s(Byte/s) </li>
</ul>
<h3 id="2-时间指标"><a href="#2-时间指标" class="headerlink" title="2 时间指标"></a>2 时间指标</h3><h4 id="1）主频f-时钟周期，外频、倍频"><a href="#1）主频f-时钟周期，外频、倍频" class="headerlink" title="1）主频f/时钟周期，外频、倍频"></a>1）主频f/时钟周期，外频、倍频</h4><p>​       <strong>主频f</strong>:指CPU内核工作的时钟频率，即CPU内数字脉冲信号震荡的速率，与CPU实际的运算能力之间不是唯一的、直接关系</p>
<p>​       **时钟周期T:**是计算机中最基本的、最小的时间单位。在一个时钟周期内，CPU仅完成一个最基本的动作</p>
<p>　　<strong>ｆ与T的关系：</strong>互为倒数</p>
<p>　　<strong>外频：</strong>指CPU（内存）与主板之间同步的时钟频率</p>
<p>　　<strong>倍频：</strong>CPU主频与外频之间的倍数</p>
<p>　　<strong>主频＝外频　ｘ　倍频</strong></p>
<h4 id="２）CPI（Clock-cycles-Per-Instruction-）"><a href="#２）CPI（Clock-cycles-Per-Instruction-）" class="headerlink" title="２）CPI（Clock　cycleｓ　Ｐｅｒ　Instruction　）"></a>２）<strong>CPI</strong>（Clock　cycleｓ　Ｐｅｒ　Instruction　）</h4><ul>
<li><p>​    执行一条指令（平均需要的时钟周期数（即T周期的个数））</p>
<p>单条指令CPI、一段程序中所有指令的CPI、指令系统CPI</p>
</li>
<li><p>CPI＝程序中所有指令的时钟周期数之和／程序中指令总数</p>
<ul>
<li>＝E（程序中各类指令的CPI　ｘ　程序中该指令的比例）</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211019234923.png" alt="image-20211019234922999"></p>
<p>CPI　＝　１＊６０％＋２＊１８％＋４＊１２％＋８＊１０％</p>
<p>​        ＝　２.２４</p>
<p><strong>IPC（Instruction　ｐｅｒ　Clock）</strong></p>
<p>​        每个时钟周期内执行的指令条数（并行）</p>
<h4 id="3-MIPS-Million-Instructions-Per-Second"><a href="#3-MIPS-Million-Instructions-Per-Second" class="headerlink" title="3) MIPS(Million Instructions Per Second)"></a>3) <strong>MIPS(Million Instructions Per Second)</strong></h4><ul>
<li><p>每秒钟CPU能执行的指令总条数（单位：百万条/秒）</p>
<p>​     MIPS = （指令条数）/（执行时间 x 10^6）</p>
<p>​               =    (指令条数)  / （所有指令CPU时钟周期数之和 / f）x 10^6</p>
<p>​               =  （f）/（CPI x 10^6 ）</p>
</li>
</ul>
<h4 id="4-CPU-时间"><a href="#4-CPU-时间" class="headerlink" title="4) CPU 时间"></a>4) CPU 时间</h4><ul>
<li><p>执行一段程序所需的时间</p>
<p>（CPU时间+I/O时间+存储访问时间+各类排队时延等）</p>
<ul>
<li><p>CPU时间 = 程序中所有指令的时钟周期数之和 x T</p>
<p>​                = 程序中所有指令的时钟周期数之和 / f</p>
</li>
</ul>
</li>
</ul>
<img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211020082443.png">

<p><strong>计算机性能指标是确定的吗</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211020082916.png" alt="image-20211020082915971"></p>
<h2 id="计算机性能测试"><a href="#计算机性能测试" class="headerlink" title="计算机性能测试"></a>计算机性能测试</h2><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211020084011.png" alt="image-20211020084011590"></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211020084101.png" alt="image-20211020084101888"></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211020084217.png" alt="image-20211020084217714"></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211020084304.png" alt="image-20211020084304800"></p>
<h2 id="Logisim基础"><a href="#Logisim基础" class="headerlink" title="Logisim基础"></a>Logisim基础</h2><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211020090131.png" alt="image-20211020090131631"></p>
<h1 id="第二章数据表示"><a href="#第二章数据表示" class="headerlink" title="第二章数据表示"></a>第二章数据表示</h1><h2 id="机器数及其特点"><a href="#机器数及其特点" class="headerlink" title="机器数及其特点"></a>机器数及其特点</h2><p><strong>组织数据，方便计算机硬件直接使用</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211020091558.png" alt="image-20211020091558169"></p>
<p><strong>三种常见的机器数：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211020092405.png" alt="image-20211020092405671"></p>
<p><strong>补码的特点</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211020092142.png" alt="image-20211020092141924"></p>
<hr>
<p><strong>移码：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211020125344.png" alt="image-20211020125344259"></p>
<p>X=+10101 [X]补=010101    [X]移=110101</p>
<p>X=-10101    [X]补=101010    [X]移=001010</p>
<p><strong>移码符号位为1表示正数，为0时表示负数</strong></p>
<h2 id="定点与浮点数据表示"><a href="#定点与浮点数据表示" class="headerlink" title="定点与浮点数据表示"></a>定点与浮点数据表示</h2><p><strong>定点数据表示</strong></p>
<ol>
<li>.可表示定点小数和整数</li>
<li>.表现形式：X0.X1X2X3…Xn.</li>
<li>定点小数表示数的范围（补码为例）：-1&lt;= x&lt;= 1-2^(-n)</li>
<li>定点整数表示数的范围（补码为例）：-2^n&lt;= x &lt;=2^n-1</li>
<li>定点数据表示数的不足：数据表示范围受限</li>
</ol>
<p><strong>浮点数据表示</strong></p>
<p>把数的范围和精度分别表示的一种数据表示方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211022090304.png" alt="image-20211022090257728"></p>
<p><strong>IEEE 754标准</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211022090718.png" alt="image-20211022090718697"></p>
<p><strong>单精度数据表示（IEEE格式相对应的32位浮点数的真值可表示为）：</strong></p>
<p>N=（-1）^S x 2^（E-127） x 1.M</p>
<p>随着E和M的取值不同，IEEE754浮点数据表示具有不同的意义：</p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211022091226.png" alt="image-20211022091226619"></p>
<p>IEEE 754 32位浮点数与对应真值之间的变换流程：</p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211022091553.png" alt="image-20211022091553838"></p>
<p>例：</p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211022092012.png" alt="image-20211022092012025"></p>
<h2 id="数据校验的基本原理"><a href="#数据校验的基本原理" class="headerlink" title="数据校验的基本原理"></a>数据校验的基本原理</h2><p><strong>码距的概念</strong></p>
<p>同一编码中，任意两个合法编码之间不同的二进制位数的最小值。</p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211022093041.png" alt="image-20211022093041275"></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023213125.png" alt="image-20211023213125767"></p>
<h2 id="奇偶校验的基本原理"><a href="#奇偶校验的基本原理" class="headerlink" title="奇偶校验的基本原理"></a>奇偶校验的基本原理</h2><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023213452.png" alt="image-20211023213452205"></p>
<p><strong>一般在同步传输方式中通常采用奇校验，异步传输方式中常采用偶校验。</strong></p>
<h2 id="CRC校验的基本原理"><a href="#CRC校验的基本原理" class="headerlink" title="CRC校验的基本原理"></a>CRC校验的基本原理</h2><p>有效信息（K位）校验信息（r位）</p>
<p>N=k+r &lt; = 2^r-1</p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023215007.png" alt="image-20211023215007528"></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023215505.png" alt="image-20211023215505009"></p>
<p><strong>CRC编码方法：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023220234.png" alt="image-20211023220234308"></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023220349.png" alt="image-20211023220349611"></p>
<h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a><strong>分析：</strong></h3><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023220637.png" alt="image-20211023220637474"></p>
<h3 id="循环特征"><a href="#循环特征" class="headerlink" title="循环特征"></a>循环特征</h3><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023220900.png" alt="image-20211023220900597"></p>
<h3 id="检错与纠错"><a href="#检错与纠错" class="headerlink" title="检错与纠错"></a>检错与纠错</h3><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023222911.png" alt="image-20211023222911342"></p>
<h2 id="海明码校验及其发现"><a href="#海明码校验及其发现" class="headerlink" title="海明码校验及其发现"></a>海明码校验及其发现</h2><h3 id="规则："><a href="#规则：" class="headerlink" title="规则："></a>规则：</h3><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023223659.png" alt="image-20211023223659441"></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023224222.png" alt="image-20211023224222282"></p>
<h3 id="计算校验位的值："><a href="#计算校验位的值：" class="headerlink" title="计算校验位的值："></a><strong>计算校验位的值：</strong></h3><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023225246.png" alt="image-20211023225246171"></p>
<h3 id="举例："><a href="#举例：" class="headerlink" title="举例："></a><strong>举例：</strong></h3><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023225133.png" alt="image-20211023225132994"></p>
<h3 id="纠错"><a href="#纠错" class="headerlink" title="纠错"></a>纠错</h3><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023225707.png" alt="image-20211023225707722"></p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul>
<li><strong>指错字G4G3G2G1 = 0000不一定无错</strong></li>
<li><strong>一位错和两位错不能由指错字区别</strong></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023230146.png" alt="image-20211023230146157"></p>
<p>因此可以在<strong>海明校验的基础上增加一位奇偶校验位</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211023230334.png" alt="image-20211023230334650"></p>
<h1 id="第三章定点数运算"><a href="#第三章定点数运算" class="headerlink" title="第三章定点数运算"></a>第三章定点数运算</h1><h2 id="定点数运算及溢出检测"><a href="#定点数运算及溢出检测" class="headerlink" title="定点数运算及溢出检测"></a>定点数运算及溢出检测</h2><p><strong>定点数加法运算：</strong></p>
<p>【X】补+【Y】补 = 【X+Y】补 mod 2^(n+1)</p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211025224226.png" alt="image-20211025224219448"></p>
<p><strong>定点数减法运算</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211025224530.png" alt="image-20211025224530083"></p>
<h3 id="溢出的概念及其判断方法"><a href="#溢出的概念及其判断方法" class="headerlink" title="溢出的概念及其判断方法"></a>溢出的概念及其判断方法</h3><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211025224741.png" alt="image-20211025224741047"></p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211025224827.png" alt="image-20211025224827111"></p>
<p><strong>判断方法</strong></p>
<ul>
<li>溢出只可能发生在同符号数相加时，包括[X]补与[Y]补；[X]补与[-Y]同号<ul>
<li>方法一：<strong>对操作数和运算结果的符号位进行检测，</strong>当结果的符号位与操作数的符号不相同时，就表明发生了溢出（设X0，Y0为参加运算的符号位，S0为结果的符号位）<ul>
<li>V=X0Y0S0反 + X0反Y0反S0，当V=1时，运算结果溢出。</li>
</ul>
</li>
<li>方法二：对最高数据进位和符号位进位进行检测：<ul>
<li><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20211025225656.png" alt="image-20211025225656656"></li>
</ul>
</li>
<li></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/26/network/EP2-%E7%9F%A5%E8%AF%86%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LZ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/26/network/EP2-%E7%9F%A5%E8%AF%86%E7%82%B9/" class="post-title-link" itemprop="url">EP2-message</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-26 12:45:25" itemprop="dateCreated datePublished" datetime="2021-04-26T12:45:25+08:00">2021-04-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-04-27 01:05:44" itemprop="dateModified" datetime="2021-04-27T01:05:44+08:00">2021-04-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C/" itemprop="url" rel="index"><span itemprop="name">网络</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="传统网络"><a href="#传统网络" class="headerlink" title="传统网络"></a>传统网络</h1><h2 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h2><h2 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h2><ol>
<li>ARP的请求报文是广播报文，应答报文是一对一的（单播）。</li>
<li>封装ARP报文的以太网帧类型字段应为：0x0806。</li>
</ol>
<h2 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h2><ol>
<li>RIPv2报文为组播报文，组播地址为224.0.0.9。</li>
<li>能隔离广播域的网元设备是路由器。</li>
</ol>
<h2 id="运输层"><a href="#运输层" class="headerlink" title="运输层"></a>运输层</h2><ol>
<li>TCP协议保证所传送的信息是正确的，IP协议负责信息的实际传送。</li>
<li>UDP报文头部的字段包括：源端口号、目标端口号、数据报长度和校验值。</li>
</ol>
<h2 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h2><ol>
<li><p>FTP服务一般运行在20和21两个端口。端口<strong>20</strong>用于在客户端和服务器之间<strong>传输数据流</strong>，而端口<strong>21</strong>用于<strong>传输控制流</strong>，并且是命令通向ftp服务器的进口。</p>
</li>
<li><p>TFTP协议是基于UDP协议的。它的端口号是<strong>69</strong>。</p>
</li>
<li><p>RIP协议是用UDP协议来封装的。</p>
</li>
<li><p><strong>DNS</strong>默认端口号为<strong>53</strong>。</p>
</li>
</ol>
<h1 id="云网络"><a href="#云网络" class="headerlink" title="云网络"></a>云网络</h1><h2 id="SDN"><a href="#SDN" class="headerlink" title="SDN"></a>SDN</h2><ol>
<li><p>OpenDaylight使用Java编写</p>
</li>
<li><p>Scapy使用Python编写</p>
</li>
<li><p>ONOS与 OpenDaylight是SDN模型中的控制器。</p>
</li>
<li><p>SDN交换机基于流表实现转发。</p>
</li>
<li><p>OpenFlow协议是基于TCP协议</p>
</li>
<li><p>ONOS的核心功能包括分布式核心平台、北向接口抽象层/APIs、南向接口抽象层/APIs、软件模块化。</p>
</li>
<li><p><strong>OVSDB协议</strong>对应的侦听端口是<strong>6640</strong>.</p>
</li>
<li><p>当<strong>iPerf</strong>不指定-p时，服务器端使用的或客户端所连接的默认端口是<strong>5001</strong>。</p>
</li>
<li><p>sFlow Collector安装启动后的默认监听端口是<strong>6343</strong>。</p>
</li>
<li><p>OpenDaylight默认启动的监听端口号是<strong>6633</strong>。</p>
</li>
<li><p>PCEP使用TCP传输机制，TCP端口号为<strong>4189</strong></p>
</li>
<li><p>Netperf默认使用TCP传输层协议。</p>
</li>
<li><p>通过Hello消息协商双方的OpenFlow版本号。</p>
</li>
<li><p>组类型：指定组的动作，分为all、select、indirect、fast failover四种。</p>
</li>
<li><p>OpenFlow交换机由流表、安全通道和OpenFlow协议三部分组成。</p>
</li>
<li><p>OpenFlow网络由OpenFlow交换机、网络虚拟化层和控制器三部分组成。</p>
</li>
<li><p>在OpenFlow v1.3流表处理过程中，多个flow tables是依次排列的，序号从0开始。</p>
</li>
<li><p>OF1.3协议中的交换机含有多个流表，每个流表中含有多个流表项，每个流表项包含多个匹配项及对应的指令。</p>
</li>
<li><p><strong>idle_time</strong>和<strong>hard_time</strong>给出了该流表项的生存时间，其中idle_time表示当这条流表项在这段时间内没有匹配到数据分组，则该流表项失效，hard_time表示自流表项下发后只要过了这段时间即刻失效；两者同时设置时，以先到的生存时间为准；两者同时为0时，流表项不会自动失效。</p>
</li>
<li><p>流表由很多个流表项组成，每个流表项就是一个转发规则。</p>
</li>
<li><p>流表项由3个基本要素组成：<strong>头字段、计数器和行动。</strong></p>
</li>
<li><p>利用CAR进行流量控制的处理：</p>
<ul>
<li>根据预先设置的匹配规则来对报文进行分类，如果是没有规定流量特性的报文，就直接继续发送，并不需要经过令牌桶的处理。</li>
</ul>
</li>
<li><p>ovs-vsctl list sflow可以查看已经配置的 sFlow Agent信息。</p>
</li>
<li><p>odl-netconf-connector-all不是安装L2Switch项目必需的组件。</p>
</li>
<li><p>单点对单点的intents：在外部路由器和SDN BGP  Speakers之间建立BGP对等会话使用单向intents。每个intents在SDN网络中连接两个连接点。每个连接点包含以下信息：SDN交换机的DPID、交换机Port和连接的BGP Speaker路由器的MAC地址。</p>
</li>
<li><p>Ganglia监控工具监控粒度为1分钟。</p>
</li>
<li><p>QoS是网络的一种安全机制，是用来解决网络延迟和阻塞等问题的一种技术。</p>
</li>
<li><p>当IPv4被作为GRE有效载荷传输时，<strong>协议类型字段</strong>被设置为<strong>0x0800</strong>。</p>
</li>
<li><p><strong>Scapy</strong>的命令：</p>
<ul>
<li>lsc()：查看scapy支持的所有的命令。</li>
<li>send：在第三层即网络层发送数据包，但没有接收功能。</li>
<li>sendp：在第二层即数据链路层发送数据包，同样没有接收功能。</li>
</ul>
</li>
<li><p>L2 Switch项目包含的服务包括地址跟踪、ARP处理器、主机跟踪、消除环路、包处理以及流表下发（主服务）等。</p>
</li>
<li><p>OpenFlow流表的包头域，用于对交换机接收到的数据包的包头内容进行匹配。流表的包头域中包括了12个元组，不包括out_port。</p>
</li>
<li><p>可以通过Packet-in/Packet-out发现交换机之间的链路</p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20210424170820.png" alt="img"></p>
<ul>
<li>SDN控制器构造PacketOut消息向S3的所有端口分别发送LLDP数据包。</li>
<li>控制器向交换机S3中下发流表，流表规则为：将从Controller端口收到的LLDP数据包从他的对应端口发送出去。</li>
<li>控制器向交换机S4中下发流表，流表规则为：将从非Controller接收到LLDP数据包发送给控制器。</li>
<li>通过以上三步，控制器只能发现h1与h2之间的单向链路。</li>
</ul>
</li>
<li><p>OpenDaylight采用了MD-SAL作为控制器平台服务层和南向接口及协议插件层的中间适配层，以实现北向接口与南向接口的解耦，保证南北向接口独立发展，互不影响。</p>
</li>
<li><p>OVSDB子项目主要包含Northbound模块、Plugin模块和OVSDB  Library模块，其中北向Northbound模块可供外部APP调用，Plugin模块主要包含api、impl、internal和error等程序包，其中api程序包主要提供OVSDB的连接、增删改查等服务，impl包中的类是其接口的实现。南向OVSDB Library通过OVSDB协议与外部通信，进行OVSDB的管理。</p>
</li>
<li><p>VXLAN网络理论上支持多达16M（即：2^24-1）的租户隔离。</p>
</li>
<li><p>OpenFlow主要有3种类型的消息，分别是Controller-to-Switch、Asynchronous（异步）和Symmetric（对称）</p>
<ul>
<li>Controller-to-Switch包括Features 、Configuration 、Modify-State 、Read-Stats 、Send-Packet和Barrier</li>
<li>异步包括Error 、Packet-in 、Flow-Removed和Port-Status</li>
<li>对称包括Hello 、Echo 和Vendor</li>
</ul>
</li>
<li><p>斯坦福大学的Nick McKeown教授和Scott Shenker教授以及Martin Casado博士在硅谷一起创办了Nicira Networks公司，这是SDN历史上第一个初创公司，也是SDN从学术圈走向工业界的标志。</p>
</li>
<li><p>P4协议支持可编程数据平面。OPenFlow协议不支持</p>
</li>
<li><p>addLink()语法可以设置带宽bw、延迟delay、最大队列的大小max_queue_size、损耗率loss。addHost()语法可以对主机CPU以百分数的形式进行设置。</p>
</li>
<li><p>Mininet中–switch参数默认使用ovsk交换机。</p>
</li>
<li><p>OpenFlow（OF）被认为是第一个软件定义网络（SDN）标准。它最初在SDN环境中定义了通信协议，使SDN控制器能够与物理和虚拟的交换机和路由器等网络设备的转发平面直接进行交互，从而更好地适应不断变化的业务需求。</p>
</li>
<li><p>Pipeline是OpenFlow交换机中实现matcing、forwarding和packet修改的flow table流水线。</p>
</li>
<li><p>计量表项由计量表项ID、计量带、计数器三个要素构成。</p>
</li>
<li><p>OpenFlow交换机定义了三种类型的OpenFlow Ports：physical ports（物理端口）、logical ports（逻辑端口）和reserved ports（预留端口），统称为标准端口。</p>
</li>
<li><p>P4的目标是成为协议无关性（Protocol Independent）、目标无关性（Target Independent）、现场可重配置（Field Reconfigurable）的语言。</p>
</li>
<li><p>在AD-SAL中，南北向API是1：1的对应关系，同一API无法被复用。所有南北向Plugin的功能都需要定义相应的AD-SAL API来承载，造成AD-SAL模块会更加庞大、实现更为复杂、维护困难性增加。</p>
</li>
<li><p>L2Switch项目包含以下几个部分：Packet Handler 、Loop Remover 、Arp Handler 、Address Tracker、Host Tracker、L2 Switch Main</p>
</li>
<li><p>odl-netconf-connector-all不是安装L2Switch项目必需的组件</p>
</li>
<li><p>NETCONF中定义了三种消息类型，分别是hello， rpc和rpc-reply, notification。</p>
</li>
<li><p>组表包括Group ID、Group Type、Counters和Action Buckets几个部分。 </p>
</li>
<li><p>通过Postman查询数据平面网络拓扑，需要借助到Topology的OPERATIONAL子资源节点。       </p>
</li>
</ol>
<p>判断</p>
<ol>
<li>OpenFlow1.3中流表包括三个字段：包头域、计数器以及行动。 X错</li>
<li>控制平面管理器（CPMan）主要是用来监控系统性能，如：CPU、MEM和硬盘利用率，I/O负载和网络流量情况等。                                               X</li>
</ol>
<h2 id="云网络-1"><a href="#云网络-1" class="headerlink" title="云网络"></a>云网络</h2><ol>
<li>Linux的磁盘分区包括主分区、逻辑分区、扩展分区和交换分区。</li>
</ol>
<h2 id="云存储"><a href="#云存储" class="headerlink" title="云存储"></a>云存储</h2><ol>
<li><p>Bigtable由客户端程序库、一个主服务器和多个子表服务器组成。</p>
<p><img src="https://cdn.jsdelivr.net/gh/LZ-00/picgo/img/20210425122417.png" alt="Bigtable架构图"></p>
</li>
<li></li>
</ol>
<h2 id="云平台"><a href="#云平台" class="headerlink" title="云平台"></a>云平台</h2><ol>
<li>OpenStack高可用架构通常有3个控制节点。</li>
<li>Keystone是 OpenStack 框架中负责管理身份验证、服务规则和服务令牌功能的模块。用户访问资源需要验证用户的身份与权限，服务执行操作也需要进行权限检测，这些都需要通过 Keystone 来处理。</li>
</ol>
<h2 id="网络虚拟化"><a href="#网络虚拟化" class="headerlink" title="网络虚拟化"></a>网络虚拟化</h2><ol>
<li>虚拟网络是指虚拟机和虚拟机、虚拟机和物理机之间的网络，这个网络需要承载在物理网络之上。</li>
<li>虚拟终端是网络定义的一种统一的终端格式，它定义了统一的字符集、终端命令、格式控制符等等，和网络虚拟化没有关系。</li>
<li>一个网络中最多只可以有4096个VLAN。</li>
<li>OpenStack中，端口是指交换设备（物理/虚拟）上的一个接口。</li>
<li>Libvirt是在KVM和虚拟机之间的一个中间层，不是KVM的一部分。</li>
</ol>
<h2 id="C4-EP2"><a href="#C4-EP2" class="headerlink" title="C4_EP2"></a>C4_EP2</h2><ol>
<li>负载均衡请求不均衡可能有以下几种原因:1.ECS实例请求连接数较少。2. 不同ECS实例的性能不同导致请求不均衡。3. 开启了会话保持功能。4.ECS健康检查异常。5. TCP Keepalive 保持长连接。</li>
<li>使用阿里云的负载均衡SLB实例时，合理的会话保持配置可以实现与某个连接(Session)相关的所有应用请求能够由同一台后端云服务器ECS实例进行处理，维持业务的延续性。四层服务的会话保持是基于_________实现的。<ul>
<li>四层服务的会话保持是基于源IP实现的，七层服务的会话保持是基于 Cookie 实现的。</li>
</ul>
</li>
<li>在阿里云专有网络VPC创建后，路由器也是随着VPC一起自动创建的，所以不需要手动创建了。这个 时候需要继续创建交换机才能在交换机中创建其他云产品。</li>
<li>流量转发四层是通过LVS实现，七层是通过 Tengine 实现</li>
<li>在负载均衡SLB中，可以通过 X-Forwarded-For 的方式获取访问者真实IP</li>
<li>实现不同地域的多个负载均衡SLB的负载，需要通过DNS轮询来实现</li>
<li>负载均衡只支持 PEM 格式的证书。</li>
<li>一个负载均衡实例最多支持添加 50个监听，每个监听配置对应后端ECS实例上的一个应用。您可以通过对后端ECS实例上的多个应用配置不同主机头的方式来满足这一需求<ul>
<li>(企业购买了一个负载均衡SLB实例，该实例下挂载了多台云服务器ECS实例，每个ECS实例上都部署了多个不同的站点，并使用不同域名访问。现在负载均衡SLB实例可以通过配置 _主机头____来实现对同一台ECS实 例上不同站点的健康检查。)</li>
</ul>
</li>
<li>当用户流量经过负载均衡某端口时，我们首先判断其是否能够匹配  上某条“转发规则”，如果匹配，则将流量转发到该规则的后端服务器组上;若不匹配并且在该监听上设置了虚  拟服务器组，那么将流量转发到该虚拟服务器组上;若用户没有在该监听上设置虚拟服务器组，即将流量转发 到实例级别添加的各后端服务器中。</li>
<li>使用阿里云的负载均衡SLB实例时，可以通过健康检查来判断后端云服务器ECS实例的可用性。针对 7 层服 务(HTTP协议)，负载均衡SLB实例通过____来判断云服务器ECS实例是否可用。<ul>
<li>四层是检查端口，七层是检查服务器端返回的状态码。</li>
</ul>
</li>
<li>打通您的VPC与传统数据中心，所以需要基于公网的 VPN 或者专线。</li>
<li><ul>
<li>同一个云服务器ECS实例只能添加到同一个伸缩组中</li>
<li>云服务器ECS实例的状态必须为运行中才能添加到伸缩组中去</li>
<li>同一个伸缩组中云服务器ECS实例必需加入负载均衡SLB白名单</li>
</ul>
</li>
<li>四层是通过SLB中设定的转发策略和规则和报文中的目标IP地址和端口分发流 量，七层是通过报文中真正有意义的应用层内容和负载均衡SLB中设定的转发策略和规则分发流量</li>
<li>主备服务器组是在监听维度上维护的，并且只支持四层监听</li>
<li>在阿里云专有网络VPC创建后，路由器也是随着VPC一起自动创建的，所以不需要手动创建了。这个 时候需要继续创建交换机才能在交换机中创建其他云产品。</li>
</ol>
<h2 id="计算"><a href="#计算" class="headerlink" title="计算"></a>计算</h2><ol>
<li><p>在使用阿里云的负载均衡SLB实例时，做了如下健康检查的配置:响应超时时间为 5 秒，健康检查间隔为 2秒，不健康阀值为 3，健康阀值为  3，即对于确认一个后端云服务器ECS实例是不健康的，需要连续三次健康检查超时。则在某后端云服务器ECS实例状态异常后，被负载均衡SLB实例从后端服务器中移出的时间窗为 是多久?</p>
<p>​    ECS被负载均衡SLB实例从后端服务器中移出的时间窗为是多久。即后端云服务器ECS实例从健康状态，到健康检查不健康状态的时间窗的时长，此题时间窗= (健康检查成功响应时间 5S x 健康阈值 3) + 检查间隔 2S x (健康阈值 3 - 1)=19S</p>
</li>
<li><p>在使用阿里云的负载均衡SLB实例时，做了如下健康检查的配置:响应超时时间为 5 秒，健康检查间隔为 2  秒，不健康阀值为3，健康阀值为3。即对于确认一个云服务器ECS实例是健康的，需要连续三次得到正常响应。如果某后端云服务器ECS实例当前状态是不健康的，现在对该实例进行修复，可以通过健康检查确认该实例是健康的时间窗是多久?</p>
<p>后端云服务器ECS实例当从不健康状态，到通过健康检查确认其健康状态的时间窗的时 长，所以此题时间窗=(健康检查成功响应时间 1S x 健康阈值 3S) + 健康检查间隔 2S x (健康阈值 3-1)=7S</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/14/framework/rabbitmq/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LZ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/14/framework/rabbitmq/" class="post-title-link" itemprop="url">rabbitmq</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-14 14:42:31" itemprop="dateCreated datePublished" datetime="2021-03-14T14:42:31+08:00">2021-03-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-27 21:43:07" itemprop="dateModified" datetime="2021-03-27T21:43:07+08:00">2021-03-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><h2 id="Rabbitmq的第一个程序"><a href="#Rabbitmq的第一个程序" class="headerlink" title="Rabbitmq的第一个程序"></a>Rabbitmq的第一个程序</h2><h3 id="AMQP协议支持的回顾"><a href="#AMQP协议支持的回顾" class="headerlink" title="AMQP协议支持的回顾"></a>AMQP协议支持的回顾</h3><p><img src="/2021/03/14/framework/rabbitmq/image-20210314144655533.png" alt="image-20210314144655533"></p>
<p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/getstarted.html">文档</a></p>
<h3 id="AMQP协议支持的消息模型"><a href="#AMQP协议支持的消息模型" class="headerlink" title="AMQP协议支持的消息模型"></a>AMQP协议支持的消息模型</h3><table>
<thead>
<tr>
<th>1 <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-python.html">“Hello World!”</a>The simplest thing that does <em>something</em><img src="/2021/03/14/framework/rabbitmq/python-one.png" alt="img"><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-python.html">Python</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-java.html">Java</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-ruby.html">Ruby</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-php.html">PHP</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-dotnet.html">C#</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-javascript.html">JavaScript</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-go.html">Go</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-elixir.html">Elixir</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-objectivec.html">Objective-C</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-swift.html">Swift</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-spring-amqp.html">Spring AMQP</a></th>
<th>2 <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-python.html">Work queues</a>Distributing tasks among workers (the <a target="_blank" rel="noopener" href="http://www.enterpriseintegrationpatterns.com/patterns/messaging/CompetingConsumers.html">competing consumers pattern</a>)<img src="/2021/03/14/framework/rabbitmq/python-two.png" alt="img"><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-python.html">Python</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-java.html">Java</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-ruby.html">Ruby</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-php.html">PHP</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-dotnet.html">C#</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-javascript.html">JavaScript</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-go.html">Go</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-elixir.html">Elixir</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-objectivec.html">Objective-C</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-swift.html">Swift</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-two-spring-amqp.html">Spring AMQP</a></th>
<th>3 <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-python.html">Publish/Subscribe</a>Sending messages to many consumers at once<img src="/2021/03/14/framework/rabbitmq/python-three.png" alt="img"><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-python.html">Python</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-java.html">Java</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-ruby.html">Ruby</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-php.html">PHP</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-dotnet.html">C#</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-javascript.html">JavaScript</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-go.html">Go</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-elixir.html">Elixir</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-objectivec.html">Objective-C</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-swift.html">Swift</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-three-spring-amqp.html">Spring AMQP</a></th>
</tr>
</thead>
<tbody><tr>
<td>4 <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-python.html">Routing</a>Receiving messages selectively<img src="/2021/03/14/framework/rabbitmq/python-four.png" alt="img"><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-python.html">Python</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-java.html">Java</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-ruby.html">Ruby</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-php.html">PHP</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-dotnet.html">C#</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-javascript.html">JavaScript</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-go.html">Go</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-elixir.html">Elixir</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-objectivec.html">Objective-C</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-swift.html">Swift</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-four-spring-amqp.html">Spring AMQP</a></td>
<td>5 <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-python.html">Topics</a>Receiving messages based on a pattern (topics)<img src="/2021/03/14/framework/rabbitmq/python-five.png" alt="img"><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-python.html">Python</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-java.html">Java</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-ruby.html">Ruby</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-php.html">PHP</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-dotnet.html">C#</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-javascript.html">JavaScript</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-go.html">Go</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-elixir.html">Elixir</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-objectivec.html">Objective-C</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-swift.html">Swift</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-five-spring-amqp.html">Spring AMQP</a></td>
<td>6 <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-six-python.html">RPC</a><a target="_blank" rel="noopener" href="http://www.enterpriseintegrationpatterns.com/patterns/messaging/RequestReply.html">Request/reply pattern</a> example<img src="/2021/03/14/framework/rabbitmq/python-six.png" alt="img"><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-six-python.html">Python</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-six-java.html">Java</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-six-ruby.html">Ruby</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-six-php.html">PHP</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-six-dotnet.html">C#</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-six-javascript.html">JavaScript</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-six-go.html">Go</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-six-elixir.html">Elixir</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-six-spring-amqp.html">Spring AMQP</a></td>
</tr>
<tr>
<td>7 <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-seven-java.html">Publisher Confirms</a>Reliable publishing with publisher confirms<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-seven-java.html">Java</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-seven-dotnet.html">C#</a><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-seven-php.html">PHP</a></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.rabbitmq/amqp-client --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--amqp依赖 rabbitmq--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="不同的模型"><a href="#不同的模型" class="headerlink" title="不同的模型"></a>不同的模型</h3><h4 id="第一种模型（直连）"><a href="#第一种模型（直连）" class="headerlink" title="第一种模型（直连）"></a>第一种模型（直连）</h4><p>在下图中，“ P”是我们的生产者，“ C”是我们的消费者。中间的框是一个队列-RabbitMQ代表使用者保留的消息缓冲区。</p>
<p><img src="/2021/03/14/framework/rabbitmq/python-one.png" alt="（P）-&gt; [|||]-&gt;（C）"></p>
<p> ==程序==</p>
<p><strong>util</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 乐。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ConnectionFactory connectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        connectionFactory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;192.168.135.128&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;rbtmq0210&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/ems&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> connectionFactory.newConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeConnection</span><span class="params">(Channel channel,Connection connection)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (channel!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                channel.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Provider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">       Channel channel = connection.createChannel();</span><br><span class="line">       <span class="comment">//通道绑定对应的消息队列</span></span><br><span class="line">       <span class="comment">//参数1：队列名称，如果对了不存在自动创建</span></span><br><span class="line">       <span class="comment">//参数2：用来定义队列特性是否被持久化</span></span><br><span class="line">       <span class="comment">//参数3：exclusive:是否独占队列</span></span><br><span class="line">       <span class="comment">//参数4：autoDelete:是否在消费完成后自动删除队列</span></span><br><span class="line">       <span class="comment">//参数5：额外附加参数</span></span><br><span class="line">	channel.queueDeclare(<span class="string">&quot;hello&quot;</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">       <span class="comment">//发布消息</span></span><br><span class="line">       <span class="comment">//参数1：交换机名称 参数2：队列名称 参数3：传递消息额外设置 参数4：消息的具体内容</span></span><br><span class="line">       channel.basicPublish(<span class="string">&quot;&quot;</span>,<span class="string">&quot;hello&quot;</span>,<span class="keyword">null</span>,<span class="string">&quot;hello rabbitmq&quot;</span>.getBytes());</span><br><span class="line"></span><br><span class="line">       <span class="comment">//关闭资源</span></span><br><span class="line">  	RabbitMQUtil.closeConnection(channel,connection);</span><br></pre></td></tr></table></figure>

<p><strong>Customer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment">//建立连接</span></span><br><span class="line">       Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        <span class="comment">//获取连接中的通道</span></span><br><span class="line">       Channel channel = connection.createChannel();</span><br><span class="line">       channel.queueDeclare(<span class="string">&quot;hello&quot;</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">       channel.basicConsume(<span class="string">&quot;hello&quot;</span>,<span class="keyword">true</span>,<span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">          	 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;【new String(body)】：&quot;</span>+<span class="keyword">new</span> String(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//不建议关闭</span></span><br><span class="line"><span class="comment">//       RabbitMQUtil.closeConnection(channel,connection);</span></span><br></pre></td></tr></table></figure>

<h4 id="第二种模型（work-queue）"><a href="#第二种模型（work-queue）" class="headerlink" title="第二种模型（work queue）"></a>第二种模型（work queue）</h4><p><img src="/2021/03/14/framework/rabbitmq/python-two.png" alt="img"></p>
<p>在这一部分中，我们将创建一个<em>工作队列</em>，该<em>队列</em>将用于在多个工作人员之间分配耗时的任务。</p>
<p>工作队列（又称<em>任务队列</em>）的主要思想是避免立即执行资源密集型任务，而不得不等待它完成。相反，我们安排任务在以后完成。我们将<em>任务</em>封装 为消息并将其发送到队列。在后台运行的工作进程将弹出任务并最终执行作业。当您运行许多工作人员时，任务将在他们之间共享。</p>
<p>这个概念在Web应用程序中特别有用，因为在Web应用程序中不可能在较短的HTTP请求窗口内处理复杂的任务。</p>
<p><strong>默认情况下，RabbitMQ将按顺序将每个消息发送给下一个使用者。平均而言，每个消费者都会收到相同数量的消息。这种分发消息的方式称为循环</strong></p>
<p>为了确保消息永不丢失，RabbitMQ支持 <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/confirms.html">消息<em>确认</em></a>。消费者发送回确认，以告知RabbitMQ已经接收，处理了特定的消息，并且RabbitMQ可以自由删除它。</p>
<p>如果使用者死了（其通道已关闭，连接已关闭或TCP连接丢失）而没有发送确认，RabbitMQ将了解消息未完全处理，并将重新排队。如果同时有其他消费者在线，它将很快将其重新分发给另一个消费者。这样，即使工人偶尔死亡，您也可以确保不会丢失任何消息。</p>
<p>没有任何消息超时；消费者死亡时，RabbitMQ将重新传递该消息。即使处理一条消息花费非常非常长的时间也没关系。</p>
<p>默认情况下，<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/confirms.html">手动消息确认</a>处于打开状态。在前面的示例中，我们通过autoAck = true 标志显式关闭了它们。现在，是时候将该标志设置为false并在工作完成后从工作人员发送适当的确认。</p>
<p><strong>能者多劳</strong></p>
<p>==代码==</p>
<p><strong>Provider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">20</span>; i++) &#123;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,<span class="string">&quot;work&quot;</span>,<span class="keyword">null</span>,(i+<span class="string">&quot;work queue&quot;</span>).getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">        RabbitMQUtil.closeConnection(channel,connection);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Customer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work&quot;</span>,<span class="keyword">true</span>,<span class="keyword">false</span>,<span class="keyword">false</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//每次消费一条消息</span></span><br><span class="line">        channel.basicQos(<span class="number">1</span>);</span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work&quot;</span>,<span class="keyword">false</span>,<span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;Customer1 customer: &quot;</span>+<span class="keyword">new</span> String(body));</span><br><span class="line">                channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第三中模型（publish-subscribe）"><a href="#第三中模型（publish-subscribe）" class="headerlink" title="第三中模型（publish/subscribe）"></a>第三中模型（publish/subscribe）</h4><p>相反，生产者只能将消息发送到<em>交换机</em>。交流是一件非常简单的事情。一方面，它接收来自生产者的消息，另一方面，将它们推入队列。交易所必须确切知道如何处理收到的消息。是否应将其附加到特定队列？是否应该将其附加到许多队列中？还是应该将其丢弃。规则由<em>交换类型</em>定义 。</p>
<p><img src="/2021/03/14/framework/rabbitmq/exchanges.png" alt="img"></p>
<p>有几种交换类型可用：direct，topic，headers 和fanout。我们将集中讨论最后一个-扇出。让我们创建这种类型的交换，并将其称为log：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.exchangeDeclare（“ logs”，“ fanout”）;</span><br></pre></td></tr></table></figure>

<p>在广播模式下，消息发送的流程是这样的：</p>
<ul>
<li>可以有多个消费者</li>
<li>每个消费者都有自己的queue</li>
<li>每个队列都要绑定到exchange</li>
<li>生产者发送的消息，只能发送到交换机，交换机来决定要发给那个队列，生产者无法决定</li>
<li>交换机把消息发送给绑定过的所有队列</li>
<li>队列的消费者都能拿到消息。实现一条消息被多个消费者消费</li>
</ul>
<p>==代码==</p>
<p><strong>Provider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Provider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        </span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;logs&quot;</span>,<span class="string">&quot;fanout&quot;</span>);</span><br><span class="line"></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;logs&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="keyword">null</span>,<span class="string">&quot;fanout type message&quot;</span>.getBytes());</span><br><span class="line"></span><br><span class="line">        RabbitMQUtil.closeConnection(channel,connection);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Customiser</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">        Channel channel = connection.createChannel();</span><br><span class="line">        <span class="comment">//绑定交换机</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;logs&quot;</span>,<span class="string">&quot;fanout&quot;</span>);</span><br><span class="line">        <span class="comment">//绑定队列</span></span><br><span class="line">        String queue = channel.queueDeclare().getQueue();</span><br><span class="line">        channel.queueBind(queue,<span class="string">&quot;logs&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        channel.basicConsume(queue,<span class="keyword">true</span>,<span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Customer1 customize: &quot;</span>+<span class="keyword">new</span> String(body));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第四种模型（routing）"><a href="#第四种模型（routing）" class="headerlink" title="第四种模型（routing）"></a>第四种模型（routing）</h4><p>1.Routing之订阅模型-Direct(直连)</p>
<p>==在fanout模式中，一条消息，会被所有的订阅的队列都消费，在某些场景下，我们希望不同的消息被不同的队列消费。这时就需要使用Direct类型的Exchange.==</p>
<p>在Direct模型下：</p>
<ul>
<li>队列与交换机的绑定不再是任意绑定，而是需要指定一个RoutingKey(路由key)</li>
<li>消息的发送方在向Exchange发送消息时，也必须指定消息的路由key</li>
<li>Exchange不在把消息交给每一个绑定的队列，而是根据消息的Routing Key进行判断，只有队列与消息的 Routing key完全一致时，才会接收到消息</li>
</ul>
<p><img src="/2021/03/14/framework/rabbitmq/python-four.png" alt="img"></p>
<p>==代码==</p>
<p><strong>Provider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">    Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">    String exchangeName = <span class="string">&quot;logs_direct&quot;</span>;</span><br><span class="line">    channel.exchangeDeclare(exchangeName,<span class="string">&quot;direct&quot;</span>);</span><br><span class="line">    String routingKey = <span class="string">&quot;error&quot;</span>;</span><br><span class="line">    channel.basicPublish(exchangeName,routingKey,<span class="keyword">null</span>,(<span class="string">&quot;这是Direct模型基于routingKey: &quot;</span>+routingKey+<span class="string">&quot;发布的消息&quot;</span>).getBytes());</span><br><span class="line"></span><br><span class="line">    RabbitMQUtil.closeConnection(channel,connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Customer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">    Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">    String exchangeName = <span class="string">&quot;logs_direct&quot;</span>;</span><br><span class="line">    channel.exchangeDeclare(exchangeName,<span class="string">&quot;direct&quot;</span>);</span><br><span class="line">    String queue = channel.queueDeclare().getQueue();</span><br><span class="line"></span><br><span class="line">    channel.queueBind(queue,exchangeName,<span class="string">&quot;info&quot;</span>);</span><br><span class="line">    channel.queueBind(queue,exchangeName,<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    channel.queueBind(queue,exchangeName,<span class="string">&quot;warning&quot;</span>);</span><br><span class="line"></span><br><span class="line">    channel.basicConsume(queue,<span class="keyword">true</span>,<span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;消费者2：&quot;</span>+<span class="keyword">new</span> String(body));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="第五种模型（topic）"><a href="#第五种模型（topic）" class="headerlink" title="第五种模型（topic）"></a>第五种模型（topic）</h4><p>绑定密钥也必须采用相同的形式。主题交换背后的逻辑 类似于直接交换-用特定路由键发送的消息将传递到所有用匹配绑定键绑定的队列。但是，绑定键有两个重要的特殊情况：</p>
<ul>
<li>*（星号）可以代替一个单词。</li>
<li>＃（哈希）可以替代零个或多个单词。</li>
</ul>
<p>在一个示例中最容易解释这一点：</p>
<p><img src="/2021/03/14/framework/rabbitmq/python-five.png" alt="img"></p>
<p>==代码==</p>
<p><strong>Provider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">    Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">    String exchangeName = <span class="string">&quot;topics&quot;</span>;</span><br><span class="line">    channel.exchangeDeclare(exchangeName,<span class="string">&quot;topic&quot;</span>);</span><br><span class="line">    String routingKey = <span class="string">&quot;user.save.update&quot;</span>;</span><br><span class="line">    channel.basicPublish(exchangeName,routingKey,<span class="keyword">null</span>,(<span class="string">&quot;这是topic模型基于routingKey: &quot;</span>+routingKey+<span class="string">&quot; 发送的消息&quot;</span>).getBytes());</span><br><span class="line"></span><br><span class="line">    RabbitMQUtil.closeConnection(channel,connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Customer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Connection connection = RabbitMQUtil.getConnection();</span><br><span class="line">    Channel channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">    String exchangeName = <span class="string">&quot;topics&quot;</span>;</span><br><span class="line">    channel.exchangeDeclare(exchangeName,<span class="string">&quot;topic&quot;</span>);</span><br><span class="line">    String queue = channel.queueDeclare().getQueue();</span><br><span class="line">    String routingKey = <span class="string">&quot;user.*&quot;</span>;</span><br><span class="line">    channel.queueBind(queue,exchangeName,routingKey);</span><br><span class="line"></span><br><span class="line">    channel.basicConsume(queue,<span class="keyword">true</span>,<span class="keyword">new</span> DefaultConsumer(channel)&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;消费者1：&quot;</span>+<span class="keyword">new</span> String(body));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="整合Spring-Boot"><a href="#整合Spring-Boot" class="headerlink" title="整合Spring Boot"></a>整合Spring Boot</h3><h4 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h4><p><strong>Provider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">helloTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">   rabbitTemplate.convertAndSend(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;springboot 整合rabbitmq 之hello world&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Customer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span> <span class="comment">// 持久化、非独占、非自动删除</span></span><br><span class="line"><span class="meta">@RabbitListener(queuesToDeclare = @Queue(&quot;hello&quot;))</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">receive</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;消费者收到消息===》&quot;</span>+message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Work"><a href="#Work" class="headerlink" title="Work"></a>Work</h4><p><strong>Provider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">workTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">      rabbitTemplate.convertAndSend(<span class="string">&quot;work&quot;</span>,<span class="string">&quot;springboot 整合rabbitmq 之work&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Customer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queuesToDeclare = @Queue(&quot;work&quot;))</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">receive1</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;receive1===&gt; &quot;</span>+message);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@RabbitListener(queuesToDeclare = @Queue(&quot;work&quot;))</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">receive2</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;receive2===&gt; &quot;</span>+message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Fanout"><a href="#Fanout" class="headerlink" title="Fanout"></a>Fanout</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fanoutTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">   rabbitTemplate.convertAndSend(<span class="string">&quot;logs&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;springboot 整合rabbitmq 之fanout&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Customer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = &#123;</span></span><br><span class="line"><span class="meta">        @QueueBinding(value = @Queue,</span></span><br><span class="line"><span class="meta">                exchange = @Exchange(value = &quot;logs&quot;, type = &quot;fanout&quot;))</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive1</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;receive1===&gt;&quot;</span> +message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = &#123;</span></span><br><span class="line"><span class="meta">        @QueueBinding(value = @Queue,//定义一个临时队列</span></span><br><span class="line"><span class="meta">                exchange = @Exchange(value = &quot;logs&quot;,type = &quot;fanout&quot;))</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive2</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;receive2===&gt;&quot;</span> +message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h4><p><strong>Provider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">routeTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">   rabbitTemplate.convertAndSend(<span class="string">&quot;logs_direct&quot;</span>,<span class="string">&quot;error&quot;</span>,<span class="string">&quot;springboot 整合rabbitmq 之routingKey:error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Customer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = &#123;</span></span><br><span class="line"><span class="meta">        @QueueBinding(value = @Queue,</span></span><br><span class="line"><span class="meta">                exchange = @Exchange(value = &quot;logs_direct&quot;,</span></span><br><span class="line"><span class="meta">                        type = &quot;direct&quot;),</span></span><br><span class="line"><span class="meta">                key = &#123;&quot;info&quot;,&quot;error&quot;,&quot;waring&quot;&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive1</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;receive1: ===&gt;&quot;</span>+message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = &#123;</span></span><br><span class="line"><span class="meta">        @QueueBinding(value = @Queue,</span></span><br><span class="line"><span class="meta">                exchange = @Exchange(value = &quot;logs_direct&quot;,</span></span><br><span class="line"><span class="meta">                        type = &quot;direct&quot;),</span></span><br><span class="line"><span class="meta">                key = &#123;&quot;info&quot;&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive2</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;receive2: ===&gt;&quot;</span>+message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h4><p><strong>Provider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">topicTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">   rabbitTemplate.convertAndSend(<span class="string">&quot;topics&quot;</span>,<span class="string">&quot;order.delete&quot;</span>,<span class="string">&quot;springboot 整合rabbitmq 之routingKey:order.delete&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Customer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = &#123;</span></span><br><span class="line"><span class="meta">        @QueueBinding(value = @Queue,</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = &quot;topics&quot;,type = &quot;topic&quot;),</span></span><br><span class="line"><span class="meta">        key = &#123;&quot;user.*&quot;&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive1</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;receive1===&gt;&quot;</span>+message);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@RabbitListener(bindings = &#123;</span></span><br><span class="line"><span class="meta">        @QueueBinding(value = @Queue,</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = &quot;topics&quot;,type = &quot;topic&quot;),</span></span><br><span class="line"><span class="meta">        key = &#123;&quot;user.*&quot;,&quot;order.*&quot;,&quot;user.#&quot;&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive2</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;receive2===&gt;&quot;</span>+message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MQ的应用场景"><a href="#MQ的应用场景" class="headerlink" title="MQ的应用场景"></a>MQ的应用场景</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/04/framework/SpringSecurity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LZ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/04/framework/SpringSecurity/" class="post-title-link" itemprop="url">SpringSecurity</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-04 15:48:18" itemprop="dateCreated datePublished" datetime="2021-03-04T15:48:18+08:00">2021-03-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-30 20:01:30" itemprop="dateModified" datetime="2021-03-30T20:01:30+08:00">2021-03-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h1><h2 id="结构总览"><a href="#结构总览" class="headerlink" title="结构总览"></a>结构总览</h2><p>Spring Security所解决的问题就是<strong>安全访问控制</strong>，而安全访问控制功能其实就是对所有进入系统的请求进行拦截，校验每个请求是否能够访问它所期望的资源。根据前边知识的学习，可以通过Filter或AOP等技术来实现，Spring Security对Web资源的保护是靠Filter实现的，所以从这个Filter来入手，逐步深入Spring Security原理。 当初始化Spring Security时，会创建一个名为 SpringSecurityFilterChain 的Servlet过滤器，类型为 org.springframework.security.web.FilterChainProxy，它实现了javax.servlet.Filter，因此外部的请求会经过此 类，下图是Spring Security过虑器链结构图： </p>
<p><img src="/2021/03/04/framework/SpringSecurity/image-20210327110951864.png" alt="image-20210327110951864"></p>
<p><img src="/2021/03/04/framework/SpringSecurity/image-20210327111323595.png" alt="image-20210327111323595"></p>
<p>下面介绍过滤器链中主要的几个过滤器及其作用： </p>
<p><strong>SecurityContextPersistenceFilter</strong> 这个Filter是整个拦截过程的入口和出口（也就是第一个和最后一个拦截 器），会在请求开始时从配置好的SecurityContextRepository 中获取 SecurityContext，然后把它设置给 </p>
<p>SecurityContextHolder。在请求完成后将 SecurityContextHolder 持有的 SecurityContext 再保存到配置好 的 SecurityContextRepository，同时清除 securityContextHolder 所持有的 SecurityContext； </p>
<p><strong>UsernamePasswordAuthenticationFilter</strong> 用于处理来自表单提交的认证。该表单必须提供对应的用户名和密 码，其内部还有登录成功或失败后进行处理的 AuthenticationSuccessHandler 和 AuthenticationFailureHandler，这些都可以根据需求做相关改变； </p>
<p><strong>FilterSecurityInterceptor</strong> 是用于保护web资源的，使AccessDecisionManager对当前用户进行授权访问，前 面已经详细介绍过了； </p>
<p><strong>ExceptionTranslationFilter</strong> 能够捕获来自 FilterChain 所有的异常，并进行处理。但是它只会处理两类异常： </p>
<p>AuthenticationException 和 AccessDeniedException，其它的异常它会继续抛出。 </p>
<h2 id="认证流程"><a href="#认证流程" class="headerlink" title="认证流程"></a>认证流程</h2><h3 id="认证流程-1"><a href="#认证流程-1" class="headerlink" title="认证流程"></a>认证流程</h3><p><img src="/2021/03/04/framework/SpringSecurity/image-20210327112016077.png" alt="image-20210327112016077"></p>
<p>仔细分析认证过程： </p>
<ol>
<li><p>用户提交用户名、密码被SecurityFilterChain中的UsernamePasswordAuthenticationFilter 过滤器获取到，封装为请求Authentication，通常情况下是UsernamePasswordAuthenticationToken这个实现类。</p>
</li>
<li><p>然后过滤器将Authentication提交至认证管理（AuthenticationManager）进行认证 </p>
</li>
<li><p>认证成功后， AuthenticationManager 身份管理器返回一个被填充满了信息的（包括上面提到的权限信息， 身份信息，细节信息，但密码通常会被移除） Authentication 实例。 </p>
</li>
<li><p>SecurityContextHolder 安全上下文容器将第3步填充了信息的 Authentication ，通过 SecurityContextHolder.getContext().setAuthentication(…)方法，设置到其中。 可以看出AuthenticationManager接口（认证管理器）是认证相关的核心接口，也是发起认证的出发点，它 的实现类为ProviderManager。而Spring Security支持多种认证方式，因此ProviderManager维护着一个 List<AuthenticationProvider> 列表，存放多种认证方式，最终实际的认证工作是由 AuthenticationProvider完成的。咱们知道web表单的对应的AuthenticationProvider实现类为 DaoAuthenticationProvider，它的内部又维护着一个UserDetailsService负责UserDetails的获取。最终 AuthenticationProvider将UserDetails填充至Authentication。 </AuthenticationProvider></p>
</li>
</ol>
<p>认证核心组件的大体关系如下：</p>
<p><img src="/2021/03/04/framework/SpringSecurity/image-20210327112657914.png" alt="image-20210327112657914"></p>
<h3 id="AuthenticationProvider"><a href="#AuthenticationProvider" class="headerlink" title="AuthenticationProvider"></a>AuthenticationProvider</h3><ul>
<li>通过前面的<strong>Spring Security**</strong>认证流程**我们得知，认证管理器（AuthenticationManager）委托 AuthenticationProvider完成认证工作。 AuthenticationProvider是一个接口，定义如下： </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line">    <span class="function">Authentication <span class="title">authenticate</span><span class="params">(Authentication var1)</span> <span class="keyword">throws</span> AuthenticationException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>authenticate</strong>()方法定义了<strong>认证的实现过程</strong>，它的参数是一个Authentication，里面包含了登录用户所提交的用 户、密码等。而返回值也是一个Authentication，这个Authentication则是在认证成功后，将用户的权限及其他信 息重新组装后生成。 Spring Security中维护着一个 List<AuthenticationProvider> 列表，存放多种认证方式，不同的认证方式使用不 同的AuthenticationProvider。如使用用户名密码登录时，使用AuthenticationProvider1，短信登录时使用 AuthenticationProvider2等等这样的例子很多。 </AuthenticationProvider></p>
<p>每个AuthenticationProvider需要实现<strong>supports**</strong>（）**方法来表明自己支持的认证方式，如我们使用表单方式认证， 在提交请求时Spring Security会生成UsernamePasswordAuthenticationToken，它是一个Authentication，里面 封装着用户提交的用户名、密码信息。而对应的，哪个AuthenticationProvider来处理它？ **</p>
<p>我们<strong>在DaoAuthenticationProvider</strong>的基类AbstractUserDetailsAuthenticationProvider发现以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> UsernamePasswordAuthenticationToken.class.isAssignableFrom(authentication);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Authentication</strong>(认证信息)的结构，它是一个接口，我们之前提到的 UsernamePasswordAuthenticationToken就是它的实现之一 </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Authentication</span> <span class="keyword">extends</span> <span class="title">Principal</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">getCredentials</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">getDetails</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">getPrincipal</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAuthenticated</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> var1)</span> <span class="keyword">throws</span> IllegalArgumentException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（1）Authentication是spring security包中的接口，直接继承自Principal类，而Principal是位于 java.security 包中的。它是表示着一个抽象主体身份，任何主体都有一个名称，因此包含一个getName()方法。 </p>
<p>（2）getAuthorities()，权限信息列表，默认是GrantedAuthority接口的一些实现类，通常是代表权限信息的一系 列字符串。 </p>
<p>（3）getCredentials()，凭证信息，用户输入的密码字符串，在认证过后通常会被移除，用于保障安全。 </p>
<p>（4）getDetails()，细节信息，web应用中的实现接口通常为 WebAuthenticationDetails，它记录了访问者的ip地 </p>
<p>址和sessionId的值。 </p>
<p>（5）**getPrincipal()**，身份信息，大部分情况下返回的是UserDetails接口的实现类，UserDetails代表用户的详细 </p>
<p>信息，那从Authentication中取出来的UserDetails就是当前登录用户信息，它也是框架中的常用接口之一。 </p>
<h3 id="UserDetailService"><a href="#UserDetailService" class="headerlink" title="UserDetailService"></a>UserDetailService</h3><p>1）认识UserDetailsService </p>
<p>现在咱们现在知道DaoAuthenticationProvider处理了web表单的认证逻辑，认证成功后既得到一个Authentication(UsernamePasswordAuthenticationToken实现)，里面包含了身份信息（Principal）。这个身份 信息就是一个 Object ，大多数情况下它可以被强转为UserDetails对象。 </p>
<p>DaoAuthenticationProvider中包含了一个UserDetailsService实例，它负责根据用户名提取用户信息 UserDetails(包含密码)，而后DaoAuthenticationProvider会去对比UserDetailsService提取的用户密码与用户提交 的密码是否匹配作为认证成功的关键依据，因此可以通过将自定义的 UserDetailsService 公开为spring bean来定 义自定义身份验证。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line">   <span class="function">UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很多人把DaoAuthenticationProvider和UserDetailsService的职责搞混淆，其实UserDetailsService只负责从特定 的地方（通常是数据库）加载用户信息，仅此而已。而DaoAuthenticationProvider的职责更大，它完成完整的认 证流程，同时会把UserDetails填充至Authentication。 </p>
<ol start="2">
<li>认识UserDetails</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetails</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它和Authentication接口很类似，比如它们都拥有username，authorities。Authentication的getCredentials()与 UserDetails中的getPassword()需要被区分对待，前者是用户提交的密码凭证，后者是用户实际存储的密码，认证 其实就是对这两者的比对。Authentication中的getAuthorities()实际是由UserDetails的getAuthorities()传递而形 成的。还记得Authentication接口中的getDetails()方法吗？其中的UserDetails用户详细信息便是经过了 AuthenticationProvider认证之后被填充的。 </p>
<p>通过实现UserDetailsService和UserDetails，我们可以完成对用户信息获取方式以及用户信息字段的扩展。 Spring Security提供的InMemoryUserDetailsManager(内存认证)，JdbcUserDetailsManager(jdbc认证)就是 UserDetailsService的实现类，主要区别无非就是从内存还是从数据库加载用户。 </p>
<h3 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a>PasswordEncoder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   String pw1 = BCrypt.hashpw(<span class="string">&quot;123&quot;</span>, BCrypt.gensalt());</span><br><span class="line">   String pw2 = BCrypt.hashpw(<span class="string">&quot;123&quot;</span>, BCrypt.gensalt());</span><br><span class="line"></span><br><span class="line">   System.out.println(pw1);</span><br><span class="line">   System.out.println(pw2);</span><br><span class="line"></span><br><span class="line">   System.out.println(BCrypt.checkpw(<span class="string">&quot;123&quot;</span>, pw1));</span><br><span class="line">   System.out.println(BCrypt.checkpw(<span class="string">&quot;123&quot;</span>, pw2));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际项目中推荐使用BCryptPasswordEncoder, Pbkdf2PasswordEncoder, SCryptPasswordEncoder等</p>
<p>使用BCryptPasswordEncoder </p>
<p>1、配置BCryptPasswordEncoder </p>
<p>在安全配置类中定义： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="授权流程"><a href="#授权流程" class="headerlink" title="授权流程"></a>授权流程</h2><h3 id="授权流程-1"><a href="#授权流程-1" class="headerlink" title="授权流程"></a>授权流程</h3><p>Spring Security可以通过 http.authorizeRequests() 对web请求进行授权保护。Spring Security使用标准Filter建立了对web请求的拦截，最终实现对资源的授权访问。 Spring Security的授权流程如下：</p>
<p><img src="/2021/03/04/framework/SpringSecurity/image-20210327134101778.png" alt="image-20210327134101778"></p>
<p>分析授权流程：</p>
<p><strong>拦截请求</strong>，已认证用户访问受保护的web资源将被SecurityFilterChain中的 FilterSecurityInterceptor 的子 </p>
<p>类拦截。 </p>
<p><strong>获取资源访问策略</strong>，FilterSecurityInterceptor会从 SecurityMetadataSource 的子类 </p>
<p>DefaultFilterInvocationSecurityMetadataSource 获取要访问当前资源所需要的权限 Collection<ConfigAttribute> 。 </ConfigAttribute></p>
<p>SecurityMetadataSource其实就是读取访问策略的抽象，而读取的内容，其实就是我们配置的访问规则， 读 </p>
<p>取访问策略如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.authorizeRequests()</span><br><span class="line">        .antMatchers(<span class="string">&quot;/r/r1&quot;</span>).hasAuthority(<span class="string">&quot;p1&quot;</span>)</span><br><span class="line">        .antMatchers(<span class="string">&quot;/r/r2&quot;</span>).hasAuthority(<span class="string">&quot;p2&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>最后，FilterSecurityInterceptor会调用 AccessDecisionManager 进行授权决策，若决策通过，则允许访问资 </p>
<p>源，否则将禁止访问。 </p>
<p>AccessDecisionManager（访问决策管理器）的核心接口如下: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccessDecisionManager</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication var1, Object var2, Collection&lt;ConfigAttribute&gt; var3)</span> <span class="keyword">throws</span> AccessDeniedException, InsufficientAuthenticationException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(ConfigAttribute var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里着重说明一下decide的参数： </p>
<p>authentication：要访问资源的访问者的身份 </p>
<p>object：要访问的受保护资源，web请求对应FilterInvocation </p>
<p>confifigAttributes：是受保护资源的访问策略，通过SecurityMetadataSource获取。 </p>
<p><strong>decide**</strong>接口就是用来鉴定当前用户是否有访问对应受保护资源的权限。** </p>
<h3 id="授权策略"><a href="#授权策略" class="headerlink" title="授权策略"></a>授权策略</h3><p>AccessDecisionManager采用<strong>投票</strong>的方式来确定是否能够访问受保护资源。 </p>
<p><img src="/2021/03/04/framework/SpringSecurity/image-20210327134546105.png" alt="image-20210327134546105"></p>
<p>通过上图可以看出，AccessDecisionManager中包含的一系列AccessDecisionVoter将会被用来对Authentication 是否有权访问受保护对象进行投票，AccessDecisionManager根据投票结果，做出最终决策。 AccessDecisionVoter是一个接口，其中定义有三个方法，具体结构如下所示。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccessDecisionVoter</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ACCESS_GRANTED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> ACCESS_ABSTAIN = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ACCESS_DENIED = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(ConfigAttribute var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">vote</span><span class="params">(Authentication var1, S var2, Collection&lt;ConfigAttribute&gt; var3)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vote()方法的返回结果会是AccessDecisionVoter中定义的三个常量之一。</p>
<p>ACCESS_GRANTED表示同意， ACCESS_DENIED表示拒绝，ACCESS_ABSTAIN表示弃权。</p>
<p>如果一个AccessDecisionVoter不能判定当前 Authentication是否拥有访问对应受保护对象的权限，则其vote()方法的返回值应当为弃权ACCESS_ABSTAIN。 </p>
<p>Spring Security内置了三个基于投票的AccessDecisionManager实现类如下，它们分别是 </p>
<p><strong>AffiffiffirmativeBased</strong>、<strong>ConsensusBased</strong>和<strong>UnanimousBased</strong>，。</p>
<p><strong>AffiffiffirmativeBased</strong>的逻辑是： </p>
<p>（1）只要有AccessDecisionVoter的投票为ACCESS_GRANTED则同意用户进行访问； </p>
<p>（2）如果全部弃权也表示通过； </p>
<p>（3）如果没有一个人投赞成票，但是有人投反对票，则将抛出AccessDeniedException。 </p>
<p>Spring security默认使用的是AffiffiffirmativeBased。 </p>
<p><strong>ConsensusBased</strong>的逻辑是： </p>
<p>（1）如果赞成票多于反对票则表示通过。 </p>
<p>（2）反过来，如果反对票多于赞成票则将抛出AccessDeniedException。 </p>
<p>（3）如果赞成票与反对票相同且不等于0，并且属性allowIfEqualGrantedDeniedDecisions的值为true，则表 </p>
<p>示通过，否则将抛出异常AccessDeniedException。参数allowIfEqualGrantedDeniedDecisions的值默认为true。 </p>
<p>（4）如果所有的AccessDecisionVoter都弃权了，则将视参数allowIfAllAbstainDecisions的值而定，如果该值 </p>
<p>为true则表示通过，否则将抛出异常AccessDeniedException。参数allowIfAllAbstainDecisions的值默认为false。 </p>
<p><strong>UnanimousBased</strong>的逻辑与另外两种实现有点不一样，另外两种会一次性把受保护对象的配置属性全部传递 </p>
<p>给AccessDecisionVoter进行投票，而UnanimousBased会一次只传递一个ConfifigAttribute给 AccessDecisionVoter进行投票。这也就意味着如果我们的AccessDecisionVoter的逻辑是只要传递进来的 ConfifigAttribute中有一个能够匹配则投赞成票，但是放到UnanimousBased中其投票结果就不一定是赞成了。 </p>
<p>UnanimousBased的逻辑具体来说是这样的： </p>
<p>（1）如果受保护对象配置的某一个ConfifigAttribute被任意的AccessDecisionVoter反对了，则将抛出 </p>
<p>AccessDeniedException。 </p>
<p>（2）如果没有反对票，但是有赞成票，则表示通过。 </p>
<p>（3）如果全部弃权了，则将视参数allowIfAllAbstainDecisions的值而定，true则通过，false则抛出 </p>
<p>AccessDeniedException。 </p>
<p>Spring Security也内置一些投票者实现类如<strong>RoleVoter</strong>、<strong>AuthenticatedVoter</strong>和<strong>WebExpressionVoter</strong>等，</p>
<h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><p><strong>获取用户信息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getUserName</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String userName = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    SecurityContext context = SecurityContextHolder.getContext();</span><br><span class="line">    Authentication authentication = context.getAuthentication();</span><br><span class="line"></span><br><span class="line">    Object principal = authentication.getPrincipal();</span><br><span class="line">    <span class="keyword">if</span> (principal == <span class="keyword">null</span>)&#123;</span><br><span class="line">        userName = <span class="string">&quot;匿名&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> UserDetails)&#123;</span><br><span class="line">        principal = (UserDetails) principal;</span><br><span class="line">        userName = ((UserDetails) principal).getUsername();</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        userName = (String) principal;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以通过以下选项准确控制会话何时创建以及Spring Security如何与之交互： </p>
<p><img src="/2021/03/04/framework/SpringSecurity/image-20210327151131193.png" alt="image-20210327151131193"></p>
<h3 id="基于方法的授权"><a href="#基于方法的授权" class="headerlink" title="基于方法的授权"></a>基于方法的授权</h3><p><strong>从数据库中获取权限信息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Perm&gt; permList = permMapper.getPermDetails(s);</span><br><span class="line">String[] perms = <span class="keyword">new</span> String[permList.size()];</span><br><span class="line">permList.stream().map(Perm::getPerm).collect(Collectors.toList()).toArray(perms);</span><br><span class="line"></span><br><span class="line">UserDetails details = org.springframework.security.core.userdetails.User.builder()</span><br><span class="line">        .username(user.getUsername())</span><br><span class="line">        .password(user.getPassword())</span><br><span class="line">        .authorities(perms).build();</span><br><span class="line"><span class="keyword">return</span> details;</span><br></pre></td></tr></table></figure>

<p><strong>添加注解支持</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br></pre></td></tr></table></figure>

<p><strong>使用注解</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/r/r1&quot;)</span></span><br><span class="line"><span class="meta">@PreAuthorize(&quot;hasAuthority(&#x27;p1&#x27;)&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;r1&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="分布式认证系统方案"><a href="#分布式认证系统方案" class="headerlink" title="分布式认证系统方案"></a>分布式认证系统方案</h1><h2 id="认证方案"><a href="#认证方案" class="headerlink" title="认证方案"></a>认证方案</h2><h3 id="基于Session的认证"><a href="#基于Session的认证" class="headerlink" title="基于Session的认证"></a>基于Session的认证</h3><p><img src="/2021/03/04/framework/SpringSecurity/image-20210327164316978.png" alt="image-20210327164316978"></p>
<p>在分布式的环境下，基于session的认证会出现一个问题，每个应用服务都需要在session中存储用户身份信息，通 过负载均衡将本地的请求分配到另一个应用服务需要将session信息带过去，否则会重新认证。 </p>
<p>这个时候，通常的做法有下面几种： </p>
<p><strong>Session**</strong>复制**：多台应用服务器之间同步session，使session保持一致，对外透明。 </p>
<p><strong>Session**</strong>黏贴**：当用户访问集群中某台服务器后，强制指定后续所有请求均落到此机器上。 </p>
<p><strong>Session**</strong>集中存储**：将Session存入分布式缓存中，所有服务器应用实例统一</p>
<p>从分布式缓存中存取Session。 </p>
<p>总体来讲，基于session认证的认证方式，可以更好的在服务端对会话进行控制，且安全性较高。但是，session机 制方式基于cookie，在复杂多样的移动客户端上不能有效的使用，并且无法跨域，另外随着系统的扩展需提高 session的复制、黏贴及存储的容错性。</p>
<h3 id="基于Token的认证"><a href="#基于Token的认证" class="headerlink" title="##基于Token的认证"></a>##基于Token的认证</h3><p>基于token的认证方式，服务端不用存储认证数据，易维护扩展性强， 客户端可以把token 存在任意地方，并且可 以实现web和app统一认证机制。其缺点也很明显，token由于自包含信息，因此一般数据量较大，而且每次请求 都需要传递，因此比较占带宽。另外，token的签名验签操作也会给cpu带来额外的处理负担。</p>
<p><img src="/2021/03/04/framework/SpringSecurity/image-20210327164546595.png" alt="image-20210327164546595"></p>
<p><strong>根据 选型的分析，决定采用基于token的认证方式，它的优点是：</strong> </p>
<p>1、适合统一认证的机制，客户端、一方应用、三方应用都遵循一致的认证机制。 </p>
<p>2、token认证方式对第三方应用接入更适合，因为它更开放，可使用当前有流行的开放协议Oauth2.0、JWT等。 </p>
<p>3、一般情况服务端无需存储会话信息，减轻了服务端的压力。分布式系统认证技术方案见下图：</p>
<p><img src="/2021/03/04/framework/SpringSecurity/image-20210327164630515.png" alt="image-20210327164630515"></p>
<p><strong>流程描述：</strong> </p>
<p>（1）用户通过接入方（应用）登录，接入方采取OAuth2.0方式在统一认证服务(UAA)中认证。 </p>
<p>（2）认证服务(UAA)调用验证该用户的身份是否合法，并获取用户权限信息。 </p>
<p>（3）认证服务(UAA)获取接入方权限信息，并验证接入方是否合法。 </p>
<p>（4）若登录用户以及接入方都合法，认证服务生成jwt令牌返回给接入方，其中jwt中包含了用户权限及接入方权 </p>
<p>限。</p>
<p>（5）后续，接入方携带jwt令牌对API网关内的微服务资源进行访问。 </p>
<p>（6）API网关对令牌解析、并验证接入方的权限是否能够访问本次请求的微服务。 </p>
<p>（7）如果接入方的权限没问题，API网关将原请求header中附加解析后的明文Token，并将请求转发至微服务。 </p>
<p>（8）微服务收到请求，明文token中包含登录用户的身份和权限信息。因此后续微服务自己可以干两件事：1，用 </p>
<p>户授权拦截（看当前用户是否有权访问该资源）2，将用户信息存储进当前线程上下文（有利于后续业务逻辑随时 </p>
<p>获取当前用户信息）</p>
<p>流程所涉及到UAA服务、API网关这三个组件职责如下： </p>
<p><strong>1）统一证服务(UAA)</strong> </p>
<p>它承载了OAuth2.0接入方认证、登入用户的认证、授权以及生成令牌的职责，完成实际的用户认证、授权功能。 </p>
<p><strong>2）API网关</strong></p>
<p>作为系统的唯一入口，API网关为接入方提供定制的API集合，它可能还具有其它职责，如身份验证、监控、负载均 </p>
<p>衡、缓存等。API网关方式的核心要点是，所有的接入方和消费端都通过统一的网关接入微服务，<strong>在网关层处理所有的非业务功能。</strong></p>
<h2 id="OAuth2-0"><a href="#OAuth2-0" class="headerlink" title="OAuth2.0"></a>OAuth2.0</h2><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p><img src="/2021/03/04/framework/SpringSecurity/image-20210327175423314.png" alt="image-20210327175423314"></p>
<p>OAuth2.0包括以下角色：</p>
<p>1、客户端 </p>
<p>本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：Android客户端、Web客户端（浏 览器端）、微信客户端等。 </p>
<p>2、资源拥有者 </p>
<p>通常为用户，也可以是应用程序，即该资源的拥有者。 </p>
<p>3、授权服务器（也称认证服务器）</p>
<p>用于服务提供商对资源拥有的身份进行认证、对访问资源进行授权，认证成功后会给客户端发放令牌 （access_token），作为客户端访问资源服务器的凭据。本例为微信的认证服务器。 </p>
<p>4、资源服务器 </p>
<p>存储资源的服务器，本例子为微信存储的用户信息。 现在还有一个问题，服务提供商能允许随便一个<strong>客户端</strong>就接入到它的<strong>授权服务器</strong>吗？</p>
<p>答案是否定的，服务提供商会 给准入的接入方一个身份，用于接入时的凭据: </p>
<p><strong>client_id</strong>：客户端标识 </p>
<p><strong>client_secret</strong>：客户端秘钥 </p>
<p>因此，准确来说，<strong>授权服务器</strong>对两种OAuth2.0中的两个角色进行认证授权，分别是<strong>资源拥有者</strong>、<strong>客户端</strong>。 </p>
<h4 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h4><p>OAuth2.0的服务提供方涵盖两个服务，即授权服务 (Authorization Server，也叫认证服务) 和资源服务 (Resource </p>
<p>Server)，使用 Spring Security OAuth2 的时候你可以选择把它们在同一个应用程序中实现，也可以选择建立使用 同一</p>
<p>个授权服务的多个资源服务。 </p>
<p><strong>授权服务</strong> <strong>(Authorization Server**</strong>）**应包含对接入端以及登入用户的合法性进行验证并颁发token等功能，对令牌 </p>
<p>的请求端点由 Spring MVC 控制器进行实现，下面是配置一个认证服务必须要实现的endpoints： </p>
<ul>
<li>AuthorizationENdpoint服务用于认证请求。默认url：<code>/oauth/authorize</code></li>
<li>TokenEndpoint服务用于访问令牌请求。默认url：<code>/oauth/token</code></li>
</ul>
<p>**资源服务(Rsource Server)**，应包含对资源的保护功能，对非法请求进行拦截，对请求中token进行解析鉴权等</p>
<ul>
<li>OAuth2AuthenticationProcessingFilter用来对请求给出的身份令牌解析鉴权。</li>
</ul>
<p><img src="/2021/03/04/framework/SpringSecurity/image-20210327180748655.png" alt="image-20210327180748655"></p>
<p>认证流程：</p>
<p>1、客户端请求UAA授权服务进行认证。 </p>
<p>2、认证通过后由UAA颁发令牌。 </p>
<p>3、客户端携带令牌Token请求资源服务。</p>
<p>4、资源服务校验令牌的合法性，合法即返回资源信息。 </p>
<h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-security&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.2.4.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- https:&#x2F;&#x2F;mvnrepository.com&#x2F;artifact&#x2F;org.springframework.cloud&#x2F;spring-cloud-starter-oauth2 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.2.2.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.security.oauth.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-security-oauth2-autoconfigure&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.3.4.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.security&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-security-jwt&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.1.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p><strong>application.properties</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">uaa‐service</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">53020</span></span><br><span class="line"><span class="meta">server.servlet.context-path</span>=<span class="string">/uaa</span></span><br><span class="line"><span class="meta">spring.main.allow‐bean‐definition‐overriding</span>=<span class="string">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#datasource</span></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/spring_security?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">lz0210</span></span><br></pre></td></tr></table></figure>

<h4 id="授权服务器配置"><a href="#授权服务器配置" class="headerlink" title="授权服务器配置"></a>授权服务器配置</h4><p>可以用 @EnableAuthorizationServer 注解并继承AuthorizationServerConfifigurerAdapter来配置OAuth2.0 授权 服务器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationServerConfigurerAdapter</span> <span class="keyword">implements</span> <span class="title">AuthorizationServerConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AuthorizationServerConfigurerAdapter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ClientDetailsServiceConfifigurer</strong>：用来配置客户端详情服（ClientDetailsService），客户端详情信息在 这里进行初始化，你能够把客户端详情信息写死在这里或者是通过数据库来存储调取详情信息。 </p>
<p><strong>AuthorizationServerEndpointsConfifigurer</strong>：用来配置令牌（token）的访问端点和令牌服务(token services)。 </p>
<p><strong>AuthorizationServerSecurityConfifigurer</strong>：用来配置令牌端点的安全约束。</p>
<h5 id="配置客户端详细信息"><a href="#配置客户端详细信息" class="headerlink" title="配置客户端详细信息"></a>配置客户端详细信息</h5><p>ClientDetailsServiceConfifigurer 能够使用内存或者JDBC来实现客户端详情服务（ClientDetailsService）， ClientDetailsService负责查找ClientDetails，而ClientDetails有几个重要的属性如下列表： </p>
<ul>
<li><p>clientId：（必须的）用来标识客户的Id。 </p>
</li>
<li><p>secret：（需要值得信任的客户端）客户端安全码，如果有的话。 </p>
</li>
<li><p>scope：用来限制客户端的访问范围，如果为空（默认）的话，那么客户端拥有全部的访问范围。 </p>
</li>
<li><p>authorizedGrantTypes：此客户端可以使用的授权类型，默认为空。 </p>
</li>
<li><p>authorities：此客户端可以使用的权限（基于Spring Security authorities）。 </p>
</li>
</ul>
<p>客户端详情（Client Details）能够在应用程序运行的时候进行更新，可以通过访问底层的存储服务（例如将客户 端详情存储在一个关系数据库的表中，就可以使用 JdbcClientDetailsService）或者通过自己实现 ClientRegistrationService接口（同时你也可以实现 ClientDetailsService 接口）来进行管理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">//        clients.withClientDetails(clientDetailsService);</span></span><br><span class="line"></span><br><span class="line">        clients.inMemory()  <span class="comment">//使用in-memory存储</span></span><br><span class="line">                .withClient(<span class="string">&quot;c1&quot;</span>)</span><br><span class="line">                .secret(<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">&quot;secret&quot;</span>))</span><br><span class="line">                .resourceIds(<span class="string">&quot;res1&quot;</span>)</span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;authorization_code&quot;</span>, <span class="string">&quot;password&quot;</span>, <span class="string">&quot;client_credentials&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;implicit&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>)</span><br><span class="line">                .scopes(<span class="string">&quot;all&quot;</span>)</span><br><span class="line">                .autoApprove(<span class="keyword">false</span>)</span><br><span class="line">                .redirectUris(<span class="string">&quot;http://www.baidu.com&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="管理令牌"><a href="#管理令牌" class="headerlink" title="管理令牌"></a>管理令牌</h5><p>AuthorizationServerTokenServices 接口定义了一些操作使得你可以对令牌进行一些必要的管理，令牌可以被用来 加载身份信息，里面包含了这个令牌的相关权限。</p>
<p>自己可以创建 AuthorizationServerTokenServices 这个接口的实现，则需要继承 <strong>DefaultTokenServices</strong> 这个类， 里面包含了一些有用实现，你可以使用它来修改令牌的格式和令牌的存储。默认的，当它尝试创建一个令牌的时 候，是使用随机值来进行填充的，除了持久化令牌是委托一个 TokenStore 接口来实现以外，这个类几乎帮你做了 所有的事情。并且 TokenStore 这个接口有一个默认的实现，它就是 InMemoryTokenStore/</p>
<ul>
<li>InMemoryTokenStore：这个版本的实现是被默认采用的，它可以完美的工作在单服务器上（即访问并发量 </li>
</ul>
<p>压力不大的情况下，并且它在失败的时候不会进行备份），大多数的项目都可以使用这个版本的实现来进行 </p>
<p>尝试，你可以在开发的时候使用它来进行管理，因为不会被保存到磁盘中，所以更易于调试。 </p>
<ul>
<li><p>JdbcTokenStore：这是一个基于JDBC的实现版本，令牌会被保存进关系型数据库。使用这个版本的实现时， 你可以在不同的服务器之间共享令牌信息。</p>
</li>
<li><p>JwtTokenStore：这个版本的全称是 JSON Web Token（JWT），它可以把令牌相关的数据进行编码（因此对 于后端服务来说，它不需要进行存储，这将是一个重大优势），但是它有一个缺点，那就是撤销一个已经授 权令牌将会非常困难，所以它通常用来处理一个生命周期较短的令牌以及撤销刷新令牌（refresh_token）。 另外一个缺点就是这个令牌占用的空间会比较大，如果你加入了比较多用户凭证信息。JwtTokenStore 不会保 牌值以及授权信息方面与 DefaultTokenServices 所扮演的角色是一样的。 </p>
</li>
</ul>
<p><strong>定义Tokenconfig</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class TokenConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public TokenStore tokenStore() &#123;</span><br><span class="line">        return new InMemoryTokenStore();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>定义AuthorizationServerTokenServices在AuthorizationServer中定义AuthorizationServerTokenServices</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenStore tokenStore;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ClientDetailsService clientDetailsService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AuthorizationServerTokenServices <span class="title">tokenService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DefaultTokenServices service = <span class="keyword">new</span> DefaultTokenServices();</span><br><span class="line">    service.setClientDetailsService(clientDetailsService);</span><br><span class="line">    service.setSupportRefreshToken(<span class="keyword">true</span>);</span><br><span class="line">    service.setTokenStore(tokenStore);</span><br><span class="line">    service.setAccessTokenValiditySeconds(<span class="number">7200</span>); <span class="comment">// 令牌默认有效期2小时</span></span><br><span class="line">    service.setRefreshTokenValiditySeconds(<span class="number">259200</span>); <span class="comment">// 刷新令牌默认有效期3天</span></span><br><span class="line">    <span class="keyword">return</span> service;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="令牌访问端点配置"><a href="#令牌访问端点配置" class="headerlink" title="令牌访问端点配置"></a>令牌访问端点配置</h5><p>AuthorizationServerEndpointsConfifigurer 这个对象的实例可以完成令牌服务以及令牌endpoint配置。</p>
<p><strong>配置授权类型（Grant Types）</strong></p>
<ul>
<li><p>authenticationManager：认证管理器，当你选择了资源所有者密码（password）授权类型的时候，请设置 这个属性注入一个 AuthenticationManager 对象。 </p>
</li>
<li><p>userDetailsService：如果你设置了这个属性的话，那说明你有一个自己的 UserDetailsService 接口的实现， 或者你可以把这个东西设置到全局域上面去（例如 GlobalAuthenticationManagerConfifigurer 这个配置对 象），当你设置了这个之后，那么 “refresh_token” 即刷新令牌授权类型模式的流程中就会包含一个检查，用 来确保这个账号是否仍然有效，假如说你禁用了这个账户的话。</p>
</li>
<li><p>authorizationCodeServices：这个属性是用来设置授权码服务的（即 AuthorizationCodeServices 的实例对象），主要用于 “authorization_code” 授权码类型模式。 </p>
</li>
<li><p>implicitGrantService：这个属性用于设置隐式授权模式，用来管理隐式授权模式的状态。 </p>
</li>
<li><p>tokenGranter：当你设置了这个东西（即 TokenGranter 接口实现），那么授权将会交由你来完全掌控，并 且会忽略掉上面的这几个属性，这个属性一般是用作拓展用途的，即标准的四种授权模式已经满足不了你的 需求的时候，才会考虑使用这个。</p>
</li>
</ul>
<p><strong>配置授权端点的URL</strong></p>
<p>AuthorizationServerEndpointsConfifigurer 这个配置对象有一个叫做 pathMapping() 的方法用来配置端点URL链 接，它有两个参数：</p>
<ul>
<li><p>第一个参数：String 类型的，这个端点URL的默认链接。 </p>
</li>
<li><p>第二个参数：String 类型的，你要进行替代的URL链接。</p>
</li>
</ul>
<p>以上的参数都将以 “/“ 字符为开始的字符串，框架的默认URL链接如下列表，可以作为这个 pathMapping() 方法的 第一个参数：</p>
<ul>
<li><p>/oauth/authorize：授权端点。 </p>
</li>
<li><p>/oauth/token：令牌端点。 </p>
</li>
<li><p>/oauth/confirm_access：用户确认授权提交端点。 </p>
</li>
<li><p>/oauth/error：授权服务错误信息端点。 </p>
</li>
<li><p>/oauth/check_token：用于资源服务访问的令牌解析端点。 </p>
</li>
<li><p>/oauth/token_key：提供公有密匙的端点，如果你使用JWT令牌的话。</p>
</li>
</ul>
<p>需要注意的是授权端点这个URL应该被Spring Security保护起来只供授权用户访问。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    endpoints.authenticationManager(authenticationManager)</span><br><span class="line">            .authorizationCodeServices(authorizationCodeServices())</span><br><span class="line">            .tokenServices(tokenService())</span><br><span class="line">            .allowedTokenEndpointRequestMethods(HttpMethod.POST);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AuthorizationCodeServices <span class="title">authorizationCodeServices</span><span class="params">()</span> </span>&#123;  <span class="comment">//设置授权码模式的授权码如何存储，这里采用内存的模式</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> InMemoryAuthorizationCodeServices();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ps</strong></p>
<p>加入AuthencationManager依赖时在WebSecurityConfig里面加入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="令牌端点的安全约束"><a href="#令牌端点的安全约束" class="headerlink" title="令牌端点的安全约束"></a>令牌端点的安全约束</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    security</span><br><span class="line">            .tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)  <span class="comment">//oauth/token_kejavay公开</span></span><br><span class="line">            .checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)    <span class="comment">///oauth/check_token公开</span></span><br><span class="line">            .allowFormAuthenticationForClients();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（1）tokenkey这个endpoint当使用JwtToken且使用非对称加密时，资源服务用于获取公钥而开放的，这里指这个 endpoint完全公开。 </p>
<p>（2）checkToken这个endpoint完全公开 </p>
<p>（3） 允许表单认证 </p>
<h5 id="web安全配置"><a href="#web安全配置" class="headerlink" title="web安全配置"></a>web安全配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InMemoryUserDetailsManager manager = <span class="keyword">new</span> InMemoryUserDetailsManager();</span><br><span class="line">        manager.createUser(User.withUsername(<span class="string">&quot;zhangsan&quot;</span>).password(<span class="string">&quot;$2a$10$KhAWzl.osgD3AH/TVU9G4OZcbzHkRC6RVJmT/6DheKeazWYhX6xE.&quot;</span>).authorities(<span class="string">&quot;p1&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> manager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/r/r1&quot;</span>).hasAuthority(<span class="string">&quot;p1&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/r/r2&quot;</span>).hasAuthority(<span class="string">&quot;p2&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/login*&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin().successForwardUrl(<span class="string">&quot;/login-success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h4><h5 id="授权码模式"><a href="#授权码模式" class="headerlink" title="授权码模式"></a>授权码模式</h5><p><img src="/2021/03/04/framework/SpringSecurity/image-20210328133614203.png" alt="image-20210328133614203"></p>
<p>（<strong>1</strong>）<strong>资源拥有者打开客户端，客户端要求资源拥有者给予授权，它将浏览器被重定向到授权服务器，重定向时附加客户端的身份信息，如：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;uaa&#x2F;oauth&#x2F;authorize?client_id&#x3D;c1&amp;response_type&#x3D;code&amp;scope&#x3D;all&amp;redirect_uri&#x3D;http:&#x2F;&#x2F;www.baidu.com</span><br></pre></td></tr></table></figure>

<p>参数列表：</p>
<ul>
<li>client_id：客户端准入标识</li>
<li>response_type：授权码模式固定为code</li>
<li>scope：客户端权限</li>
<li>redirect_url：跳转uri，当授权码申请成功后会跳转到此地址，并在后边code参数(授权码)。</li>
</ul>
<p><strong>（2）浏览器出现向授权服务器授权界面，之后用户同意授权</strong></p>
<p>**（3）授权服务器将授权码（AuthorizationCode）转经浏览器发送给client（通过redirect_uri)**。</p>
<p><strong>（4）客户端拿着授权码向授权服务器索要访问access_token，请求如下：</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;uaa&#x2F;oauth&#x2F;token? client_id&#x3D;c1&amp;client_secret&#x3D;secret&amp;grant_type&#x3D;authorization_code&amp;code&#x3D;5PgfcD&amp;redirect_uri&#x3D;http:&#x2F;&#x2F;www.baidu.com</span><br></pre></td></tr></table></figure>

<p>参数列表如下 :</p>
<ul>
<li><p>client_id：客户端准入标识。 </p>
</li>
<li><p>client_secret：客户端秘钥。 </p>
</li>
<li><p>grant_type：授权类型，填写authorization_code，表示授权码模式 </p>
</li>
<li><p>code：授权码，就是刚刚获取的授权码，注意：授权码只使用一次就无效了，需要重新申请。 </p>
</li>
<li><p>redirect_uri：申请授权码时的跳转url，一定和申请授权码时用的redirect_uri一致。</p>
</li>
</ul>
<p><strong>（5）授权服务器返回令牌(access_token)</strong> </p>
<p>这种模式是四种模式中最安全的一种模式。一般用于<strong>client是Web服务器端应用或第三方的原生App调用资源服务 的时候。</strong>因为在这种模式中access_token不会经过浏览器或移动端的App，而是直接从服务端去交换，这样就最 限度的减小了令牌泄漏的风险。</p>
<h5 id="简化模式"><a href="#简化模式" class="headerlink" title="简化模式"></a>简化模式</h5><p><img src="/2021/03/04/framework/SpringSecurity/image-20210328135248167.png" alt="image-20210328135248167"></p>
<p><strong>资源拥有者打开客户端，客户端要求资源拥有者给予授权，它将浏览器被重定向到授权服务器，重定向时会附加客户端的身份信息。如：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;uaa&#x2F;oauth&#x2F;authorize?client_id&#x3D;c1&amp;response_type&#x3D;token&amp;scope&#x3D;all&amp;redirect_uri&#x3D;http:&#x2F;&#x2F;www.baidu.com</span><br></pre></td></tr></table></figure>

<p>参数描述同<strong>授权码模式</strong> ，注意response_type=token，说明是简化模式。</p>
<p><strong>（2）浏览器出现向授权服务器授权页面，之后将用户同意授权。</strong> </p>
<p>（<strong>3）授权服务器将授权码将令牌（access_token）以Hash的形式存放在重定向uri的fargment中发送给浏览器。</strong></p>
<p>==般来说，简化模式用于没有服务器端的第三方单页面应用，因为没有服务器端就无法接收授权码。==</p>
<h5 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h5><p><img src="/2021/03/04/framework/SpringSecurity/image-20210328135634399.png" alt="image-20210328135634399"></p>
<p><strong>（1）资源拥有者将用户名、密码发送给客户端</strong> </p>
<p><strong>（2）客户端拿着资源拥有者的用户名、密码向授权服务器请求令牌（access_token），请求如下：</strong> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;uaa&#x2F;oauth&#x2F;token? client_id&#x3D;c1&amp;client_secret&#x3D;secret&amp;grant_type&#x3D;password&amp;username&#x3D;shangsan&amp;password&#x3D;123</span><br></pre></td></tr></table></figure>

<p>参数列表如下： </p>
<ul>
<li><p>client_id：客户端准入标识。 </p>
</li>
<li><p>client_secret：客户端秘钥。 </p>
</li>
<li><p>grant_type：授权类型，填写password表示密码模式 </p>
</li>
<li><p>username：资源拥有者用户名。 </p>
</li>
<li><p>password：资源拥有者密码。</p>
</li>
</ul>
<p><strong>（3）授权服务器将令牌（access_token）发送给client</strong> </p>
<p>这种模式十分简单，但是却意味着直接将用户敏感信息泄漏给了client，因此这就说明这种模式只能用于client是我 们自己开发的情况下。因此密码模式一般用于我们自己开发的，第一方原生App或第一方单页面应用</p>
<h5 id="客户端模式"><a href="#客户端模式" class="headerlink" title="客户端模式"></a>客户端模式</h5><p><img src="/2021/03/04/framework/SpringSecurity/image-20210328135915042.png" alt="image-20210328135915042"></p>
<p><strong>（1）客户端向授权服务器发送自己的身份信息，并请求令牌（access_token）</strong> </p>
<p><strong>（2）确认客户端身份无误后，将令牌（access_token）发送给client，请求如下：**</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;uaa&#x2F;oauth&#x2F;token?client_id&#x3D;c1&amp;client_secret&#x3D;secret&amp;grant_type&#x3D;client_credentials</span><br></pre></td></tr></table></figure>

<p>参数列表如下： </p>
<ul>
<li><p>client_id：客户端准入标识。 </p>
</li>
<li><p>client_secret：客户端秘钥。 </p>
</li>
<li><p>grant_type：授权类型，填写client_credentials表示客户端模式 </p>
</li>
</ul>
<p>==这种模式是最方便但最不安全的模式。因此这就要求我们对client完全的信任，而client本身也是安全的。因 此这种模式一般用来提供给我们完全信任的服务器端服务。比如，合作方系统对接，拉取一组用户信息。==</p>
<h4 id="资源服务器配置"><a href="#资源服务器配置" class="headerlink" title="资源服务器配置"></a>资源服务器配置</h4><h5 id="资源服务器配置-1"><a href="#资源服务器配置-1" class="headerlink" title="资源服务器配置"></a>资源服务器配置</h5><p>@EnableResourceServer 注解到一个 @Confifiguration 配置类上，并且必须使用 ResourceServerConfifigurer 个 配置对象来进行配置（可以选择继承自 ResourceServerConfifigurerAdapter 然后覆写其中的方法，参数就是这个 对象的实例），下面是一些可以配置的属性： </p>
<p>ResourceServerSecurityConfifigurer中主要包括： </p>
<ul>
<li><p>tokenServices：ResourceServerTokenServices 类的实例，用来实现令牌服务。 </p>
</li>
<li><p>tokenStore：TokenStore类的实例，指定令牌如何访问，与tokenServices配置可选 </p>
</li>
<li><p>resourceId：这个资源服务的ID，这个属性是可选的，但是推荐设置并在授权服务中进行验证。 </p>
</li>
<li><p>其他的拓展属性例如 tokenExtractor 令牌提取器用来提取请求中的令牌。 </p>
</li>
</ul>
<p>HttpSecurity配置这个与Spring Security类似：</p>
<ul>
<li><p>请求匹配器，用来设置需要进行保护的资源路径，默认的情况下是保护资源服务的全部路径。 </p>
</li>
<li><p>通过http.authorizeRequests()来设置受保护资源的访问规则 </p>
</li>
<li><p>其他的自定义权限保护规则通过 HttpSecurity 来进行配置。</p>
</li>
</ul>
<p>@EnableResourceServer 注解自动增加了一个类型为OAuth2AuthenticationProcessingFilter 的过滤器链 编写ResouceServerConfifig：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServiceConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RESOURCE_ID = <span class="string">&quot;res1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        resources.resourceId(RESOURCE_ID)</span><br><span class="line">                .tokenServices(tokenService())</span><br><span class="line">                .stateless(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResourceServerTokenServices <span class="title">tokenService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//使用远程服务请求授权服务器校验token,必须指定校验token 的url、client_id，client_secret</span></span><br><span class="line">        RemoteTokenServices tokenServices = <span class="keyword">new</span> RemoteTokenServices();</span><br><span class="line">        tokenServices.setCheckTokenEndpointUrl(<span class="string">&quot;http://localhost:53020/uaa/oauth/check_token&quot;</span>);</span><br><span class="line">        tokenServices.setClientId(<span class="string">&quot;c1&quot;</span>);</span><br><span class="line">        tokenServices.setClientSecret(<span class="string">&quot;secret&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> tokenServices;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/**&quot;</span>).access(<span class="string">&quot;#oauth2.hasScope(&#x27;all&#x27;)&quot;</span>)</span><br><span class="line">                .and().csrf().disable()</span><br><span class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>6.2.7.2</strong> <strong>验证**</strong>token** </p>
<p>ResourceServerTokenServices 是组成授权服务的另一半，如果你的授权服务和资源服务在同一个应用程序上的 话，你可以使用 DefaultTokenServices ，这样的话，你就不用考虑关于实现所有必要的接口的一致性问题。如果 你的资源服务器是分离开的，那么你就必须要确保能够有匹配授权服务提供的ResourceServerTokenServices，它 知道如何对令牌进行解码。</p>
<p><strong>令牌解析方法</strong>： </p>
<p>​    使用 DefaultTokenServices 在资源服务器本地配置令牌存储、解码、解析方式 </p>
<p>​    使用 RemoteTokenServices 资源服务器通过 HTTP 请求来解码令牌，每次都请求授权服务器端点 /oauth/check_token 使用授权服务的 /oauth/check_token 端点你需要在授权服务将这个端点暴露出去，以便资源服务可以进行访问， </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    security</span><br><span class="line">            .tokenKeyAccess(<span class="string">&quot;permitAll()&quot;</span>)  <span class="comment">//oauth/token_key公开</span></span><br><span class="line">            .checkTokenAccess(<span class="string">&quot;permitAll()&quot;</span>)    <span class="comment">///oauth/check_token公开</span></span><br><span class="line">            .allowFormAuthenticationForClients();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>==在资源 服务配置RemoteTokenServices ，在ResouceServerConfifig中配置：==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResourceServerTokenServices <span class="title">tokenService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//使用远程服务请求授权服务器校验token,必须指定校验token 的url、client_id，client_secret</span></span><br><span class="line">    RemoteTokenServices tokenServices = <span class="keyword">new</span> RemoteTokenServices();</span><br><span class="line">    tokenServices.setCheckTokenEndpointUrl(<span class="string">&quot;http://localhost:53020/uaa/oauth/check_token&quot;</span>);</span><br><span class="line">    tokenServices.setClientId(<span class="string">&quot;c1&quot;</span>);</span><br><span class="line">    tokenServices.setClientSecret(<span class="string">&quot;secret&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> tokenServices;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>test</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/r1&quot;)</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasAnyAuthority(&#x27;p2&#x27;)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">r1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;访问资源1&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>添加安全访问控制</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(securedEnabled = true,prePostEnabled = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)</span><br><span class="line">                .and()</span><br><span class="line"></span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                <span class="comment">/*.antMatchers(&quot;/r/r1&quot;).hasAuthority(&quot;p1&quot;)</span></span><br><span class="line"><span class="comment">                .antMatchers(&quot;/r/r2&quot;).hasAuthority(&quot;p2&quot;)*/</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/login*&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line"></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin().successForwardUrl(<span class="string">&quot;/login-success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>请求资源</strong> </p>
<p>按照oauth2.0协议要求，请求资源需要携带token，如下： </p>
<p>token的参数名称为：<strong>Authorization</strong>，值为：<strong>Bearer token</strong>值</p>
<h4 id="使用JWT令牌"><a href="#使用JWT令牌" class="headerlink" title="使用JWT令牌"></a>使用JWT令牌</h4><p><strong>jWT令牌的组成</strong></p>
<p>xxx.xxx.xxx</p>
<p><strong>第一部分</strong>：header 包含令牌的类型及使用的算法</p>
<p><strong>第二部分</strong>：payload 存放一些用户信息</p>
<p><strong>第三部分</strong>：signature HMACSHA256( base64UrlEncode(header) + “.”+base64UrlEncode(payload), secret) </p>
<p><strong>1.TokenConfig</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SIGNING_KEY = <span class="string">&quot;uaa123&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">tokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtTokenStore(accessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">accessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        converter.setSigningKey(SIGNING_KEY); <span class="comment">//对称秘钥，资源服务器使用该秘钥来验证 return converter;</span></span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  @Bean</span></span><br><span class="line"><span class="comment">    public TokenStore tokenStore() &#123;</span></span><br><span class="line"><span class="comment">        return new InMemoryTokenStore();</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.定义JWT令牌服务</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtAccessTokenConverter accessTokenConverter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationServerTokenServices <span class="title">tokenService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultTokenServices service = <span class="keyword">new</span> DefaultTokenServices();</span><br><span class="line">        service.setClientDetailsService(clientDetailsService);</span><br><span class="line">        service.setSupportRefreshToken(<span class="keyword">true</span>);</span><br><span class="line">        service.setTokenStore(tokenStore);</span><br><span class="line">        <span class="comment">//使用jwt令牌的形式</span></span><br><span class="line">        TokenEnhancerChain tokenEnhancerChain = <span class="keyword">new</span> TokenEnhancerChain();</span><br><span class="line">        tokenEnhancerChain.setTokenEnhancers(Arrays.asList(accessTokenConverter));</span><br><span class="line">        service.setTokenEnhancer(tokenEnhancerChain);</span><br><span class="line"></span><br><span class="line">        service.setAccessTokenValiditySeconds(<span class="number">7200</span>); <span class="comment">// 令牌默认有效期2小时</span></span><br><span class="line">        service.setRefreshTokenValiditySeconds(<span class="number">259200</span>); <span class="comment">// 刷新令牌默认有效期3天</span></span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>3.校验JWT令牌</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServiceConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RESOURCE_ID = <span class="string">&quot;res1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TokenStore tokenStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        resources.resourceId(RESOURCE_ID)</span><br><span class="line">                .tokenStore(tokenStore)</span><br><span class="line"><span class="comment">//                .tokenServices(tokenService())</span></span><br><span class="line">                .stateless(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*@Bean</span></span><br><span class="line"><span class="comment">    public ResourceServerTokenServices tokenService() &#123;</span></span><br><span class="line"><span class="comment">        //使用远程服务请求授权服务器校验token,必须指定校验token 的url、client_id，client_secret</span></span><br><span class="line"><span class="comment">        RemoteTokenServices tokenServices = new RemoteTokenServices();</span></span><br><span class="line"><span class="comment">        tokenServices.setCheckTokenEndpointUrl(&quot;http://localhost:53020/uaa/oauth/check_token&quot;);</span></span><br><span class="line"><span class="comment">        tokenServices.setClientId(&quot;c1&quot;);</span></span><br><span class="line"><span class="comment">        tokenServices.setClientSecret(&quot;secret&quot;);</span></span><br><span class="line"><span class="comment">        return tokenServices;</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="完善环境配置"><a href="#完善环境配置" class="headerlink" title="完善环境配置"></a>完善环境配置</h4><p><strong>使用数据库存储客户端信息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">ClientDetailsService <span class="title">clientDetailsService</span><span class="params">(DataSource dataSource)</span></span>&#123;</span><br><span class="line">    JdbcClientDetailsService detailsService = <span class="keyword">new</span> JdbcClientDetailsService(dataSource);</span><br><span class="line">    detailsService.setPasswordEncoder(passwordEncoder);</span><br><span class="line">    <span class="keyword">return</span> detailsService;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    clients.withClientDetails(clientDetailsService);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationCodeServices <span class="title">authorizationCodeServices</span><span class="params">(DataSource dataSource)</span> </span>&#123;  <span class="comment">//设置授权码模式的授权码如何存储，这里采用内存的模式</span></span><br><span class="line"><span class="comment">//        return new InMemoryAuthorizationCodeServices();</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcAuthorizationCodeServices(dataSource);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用数据库存储授权码信息</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationCodeServices <span class="title">authorizationCodeServices</span><span class="params">(DataSource dataSource)</span> </span>&#123;  <span class="comment">//设置授权码模式的授权码如何存储，这里采用内存的模式</span></span><br><span class="line"><span class="comment">//        return new InMemoryAuthorizationCodeServices();</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcAuthorizationCodeServices(dataSource);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/23/language/python/python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LZ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/23/language/python/python/" class="post-title-link" itemprop="url">python</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-01-23 10:38:29" itemprop="dateCreated datePublished" datetime="2021-01-23T10:38:29+08:00">2021-01-23</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/01/01/language/java/juc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LZ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/01/language/java/juc/" class="post-title-link" itemprop="url">Juc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-01-01 21:37:22 / Modified: 21:38:27" itemprop="dateCreated datePublished" datetime="2021-01-01T21:37:22+08:00">2021-01-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">language</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/31/language/java/nio/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LZ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/31/language/java/nio/" class="post-title-link" itemprop="url">NIO</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-31 16:41:16" itemprop="dateCreated datePublished" datetime="2020-12-31T16:41:16+08:00">2020-12-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-01 20:13:19" itemprop="dateModified" datetime="2021-01-01T20:13:19+08:00">2021-01-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/language/" itemprop="url" rel="index"><span itemprop="name">language</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="NIO"><a href="#NIO" class="headerlink" title="NIO"></a>NIO</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><strong>Java NIO（New IO）：</strong></p>
<p>从Java 1.4版本开始引入的一个新的IO API，<strong>可以替代标准的Java IO API。</strong>NIO与原来的IO有同样的作用和目的，但是使用的方式完全不同，NIO<strong>支持面向缓冲区的、基于通道的IO操作</strong>。NIO将以<strong>更加高效的方式进行文件的读写</strong>操作。</p>
<h2 id="IO与NIO的区别"><a href="#IO与NIO的区别" class="headerlink" title="IO与NIO的区别"></a><strong>IO与NIO的区别</strong></h2><p><img src="/2020/12/31/language/java/nio/image-20201231164653615.png" alt="image-20201231164653615"></p>
<h2 id="通道和缓冲区"><a href="#通道和缓冲区" class="headerlink" title="通道和缓冲区"></a>通道和缓冲区</h2><p><strong>Java NIO系统的核心在于</strong>：通道(Channel)和缓冲区(Buffer)。</p>
<p><strong>通道表示</strong>打开到IO 设备(例如：文件、套接字)的连接。若需要使用NIO 系统，<strong>需要获取用于连接IO 设备的通道以及用于容纳数据的缓冲区。然后操作缓冲区，对数据进行处理。</strong></p>
<p>==简而言之，Channel 负责传输，Buffer 负责存储==</p>
<h3 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1.缓冲区(Buffer)：在Java NIO中负责数据的存取/缓冲区底层就是数组。用于存储不同数据类型的数据</span></span><br><span class="line"><span class="comment"> * 根据数据类型不同提供了不同类型的缓冲区（boolean除外）</span></span><br><span class="line"><span class="comment"> * ByteBuffer</span></span><br><span class="line"><span class="comment"> * ShortBuffer</span></span><br><span class="line"><span class="comment"> * CharBuffer</span></span><br><span class="line"><span class="comment"> * IntBuffer</span></span><br><span class="line"><span class="comment"> * LongBuffer</span></span><br><span class="line"><span class="comment"> * FloatBuffer</span></span><br><span class="line"><span class="comment"> * DoubleBuffer</span></span><br><span class="line"><span class="comment"> * 上述缓冲区可以通过.allocate()获取</span></span><br><span class="line"><span class="comment"> * 2.直接缓冲区与非直接缓冲区：</span></span><br><span class="line"><span class="comment"> * 非直接缓冲区：应通过allocate方法分配缓冲区，将缓存建立在jvm缓冲区里面</span></span><br><span class="line"><span class="comment"> * 直接缓冲区：应通过allocateDirect方法分配缓冲区，将缓存建立在物理缓存里面</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/31/language/java/nio/image-20210101110936418.png" alt="image-20210101110936418"></p>
<p><strong>demo1</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">     <span class="function"><span class="keyword">void</span> <span class="title">testBuffer</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String str = <span class="string">&quot;abcde&quot;</span>;</span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">//put</span></span><br><span class="line">        buffer.put(str.getBytes());</span><br><span class="line">        System.out.println(<span class="string">&quot;position； &quot;</span>+buffer.position());</span><br><span class="line">        System.out.println(<span class="string">&quot;limit； &quot;</span>+buffer.limit());</span><br><span class="line">        System.out.println(<span class="string">&quot;capacity； &quot;</span>+buffer.capacity());</span><br><span class="line">        <span class="comment">//切换成读的状态（变换position、limit的位置）</span></span><br><span class="line">        buffer.flip();</span><br><span class="line">        <span class="keyword">byte</span>[] dst = <span class="keyword">new</span> <span class="keyword">byte</span>[buffer.limit()];</span><br><span class="line">        buffer.get(dst,<span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(dst));</span><br><span class="line">        System.out.println(buffer.position());</span><br><span class="line">        <span class="comment">//mark():  标记</span></span><br><span class="line">        buffer.mark();</span><br><span class="line">        buffer.get(dst,<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(dst));</span><br><span class="line">        System.out.println(buffer.position());</span><br><span class="line">        <span class="comment">//reset(): 恢复到mark位置</span></span><br><span class="line">        buffer.reset();</span><br><span class="line">        System.out.println(buffer.position());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>demo2</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sout:</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">------------put-----------------</span></span><br><span class="line"><span class="comment">position； 4</span></span><br><span class="line"><span class="comment">limit； 1024</span></span><br><span class="line"><span class="comment">capacity； 1024</span></span><br><span class="line"><span class="comment">------------flip-----------------</span></span><br><span class="line"><span class="comment">position； 0</span></span><br><span class="line"><span class="comment">limit； 4</span></span><br><span class="line"><span class="comment">capacity； 1024</span></span><br><span class="line"><span class="comment">------------get-----------------</span></span><br><span class="line"><span class="comment">ab  </span></span><br><span class="line"><span class="comment">position； 2</span></span><br><span class="line"><span class="comment">limit； 4</span></span><br><span class="line"><span class="comment">capacity； 1024</span></span><br><span class="line"><span class="comment">------------rewind-----------------</span></span><br><span class="line"><span class="comment">position； 0</span></span><br><span class="line"><span class="comment">limit； 4</span></span><br><span class="line"><span class="comment">capacity； 1024</span></span><br><span class="line"><span class="comment">------------clear-----------------</span></span><br><span class="line"><span class="comment">position； 0</span></span><br><span class="line"><span class="comment">limit； 1024</span></span><br><span class="line"><span class="comment">capacity； 1024</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> public final Buffer clear() &#123;</span></span><br><span class="line"><span class="comment">              position = 0;</span></span><br><span class="line"><span class="comment">               limit = capacity;</span></span><br><span class="line"><span class="comment">               mark = -1;</span></span><br><span class="line"><span class="comment">               return this;</span></span><br><span class="line"><span class="comment">           &#125;</span></span><br><span class="line"><span class="comment"> public final Buffer flip() &#123;</span></span><br><span class="line"><span class="comment">                limit = position;</span></span><br><span class="line"><span class="comment">                position = 0;</span></span><br><span class="line"><span class="comment">                mark = -1;</span></span><br><span class="line"><span class="comment">                return this;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment"> public final Buffer rewind() &#123;</span></span><br><span class="line"><span class="comment">                position = 0;</span></span><br><span class="line"><span class="comment">                mark = -1;</span></span><br><span class="line"><span class="comment">                return this;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">testBuffer1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String str = <span class="string">&quot;abcd&quot;</span>;</span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        buffer.put(str.getBytes());</span><br><span class="line">        System.out.println(<span class="string">&quot;------------put-----------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;position； &quot;</span>+buffer.position());</span><br><span class="line">        System.out.println(<span class="string">&quot;limit； &quot;</span>+buffer.limit());</span><br><span class="line">        System.out.println(<span class="string">&quot;capacity； &quot;</span>+buffer.capacity());</span><br><span class="line">        <span class="comment">//切换成读的状态（变换position、limit的位置）</span></span><br><span class="line">        buffer.flip();</span><br><span class="line">        System.out.println(<span class="string">&quot;------------flip-----------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;position； &quot;</span>+buffer.position());</span><br><span class="line">        System.out.println(<span class="string">&quot;limit； &quot;</span>+buffer.limit());</span><br><span class="line">        System.out.println(<span class="string">&quot;capacity； &quot;</span>+buffer.capacity());</span><br><span class="line">        <span class="comment">//get读取缓冲区数据</span></span><br><span class="line">        <span class="keyword">byte</span>[] dst = <span class="keyword">new</span> <span class="keyword">byte</span>[buffer.limit()];</span><br><span class="line">        buffer.get(dst,<span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;------------get-----------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(dst));</span><br><span class="line">        System.out.println(<span class="string">&quot;position； &quot;</span>+buffer.position());</span><br><span class="line">        System.out.println(<span class="string">&quot;limit； &quot;</span>+buffer.limit());</span><br><span class="line">        System.out.println(<span class="string">&quot;capacity； &quot;</span>+buffer.capacity());</span><br><span class="line">        <span class="comment">//rewind 可重复读</span></span><br><span class="line">        buffer.rewind();</span><br><span class="line">        System.out.println(<span class="string">&quot;------------rewind-----------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;position； &quot;</span>+buffer.position());</span><br><span class="line">        System.out.println(<span class="string">&quot;limit； &quot;</span>+buffer.limit());</span><br><span class="line">        System.out.println(<span class="string">&quot;capacity； &quot;</span>+buffer.capacity());</span><br><span class="line">        <span class="comment">//clear (缓冲区数据依然存在，但数据处于被遗忘状态)</span></span><br><span class="line">        buffer.clear();</span><br><span class="line">        System.out.println(<span class="string">&quot;------------clear-----------------&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;position； &quot;</span>+buffer.position());</span><br><span class="line">        System.out.println(<span class="string">&quot;limit； &quot;</span>+buffer.limit());</span><br><span class="line">        System.out.println(<span class="string">&quot;capacity； &quot;</span>+buffer.capacity());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="直接缓冲区与非直接缓冲区"><a href="#直接缓冲区与非直接缓冲区" class="headerlink" title="直接缓冲区与非直接缓冲区"></a>直接缓冲区与非直接缓冲区</h4><p><strong>字节缓冲区</strong>要么是直接的，要么是非直接的。如果为<strong>直接字节缓冲区</strong>，则<strong>Java 虚拟机会尽最大努力直接在此缓冲区上执行本机I/O 操作</strong>。也就是说，在每次调用基础操作系统的一个本机I/O 操作之前（或之后），<strong>虚拟机都会尽量避免将缓冲区的内容复制到中间缓冲区中</strong>（或从中间缓冲区中复制内容）。</p>
<p><strong>直接字节缓冲区</strong>可以通过调用此类的<strong>allocateDirect()</strong> 工厂方法来创建。此方法返回的缓冲区进行分配和取消分配<strong>所需成本通常高于非直接缓冲区。直接缓冲区的内容可以驻留在常规的垃圾回收堆之外</strong>，因此，它们对应用程序的内存需求量造成的影响可能并不明显。所以，<strong>建议将直接缓冲区主要分配给那些易受基础系统的本机I/O 操作影响的大型、持久的缓冲区</strong>。一般情况下，最好仅在直接缓冲区能在程序性能方面带来明显好处时分配它们。</p>
<p><strong>直接字节缓冲区</strong>还可以通过<strong>FileChannel 的map()</strong> 方法将文件区域直接映射到内存中来创建。该方法返回MappedByteBuffer。Java 平台的实现有助于通过JNI 从本机代码创建直接字节缓冲区。<strong>如果以上这些缓冲区中的某个缓冲区实例指的是不可访问的内存区域，则试图访问该区域不会更改该缓冲区的内容，并且将会在访问期间或稍后的某个时间导致抛出不确定的异常。</strong></p>
<p>字节缓冲区是直接缓冲区还是非直接缓冲区可通过调用其**isDirect()**方法来确定。提供此方法是为了能够在性能关键型代码中执行显式缓冲区管理。</p>
<p>==Different==</p>
<p><img src="/2020/12/31/language/java/nio/image-20210101111623218.png" alt="image-20210101111623218"></p>
<p><img src="/2020/12/31/language/java/nio/image-20210101111639301.png" alt="image-20210101111639301"></p>
<h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><p><strong>通道（Channel）</strong>：由java.nio.channels 包定义的。Channel 表示<strong>IO 源与目标打开的连接</strong>。Channel 类似于传统的“流”。只不过Channel 本身不能直接访问数据，Channel 只能与Buffer 进行交互。</p>
<p><img src="/2020/12/31/language/java/nio/image-20210101114907016.png" alt="image-20210101114907016"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  一、通道（Channel）：用于源节点与目标节点的连接。在Java NIO中负责将缓冲区中数据的传输。Channel本身不存储数据，因此需要配合缓冲区进行传输</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  二、通道的主要实现类</span></span><br><span class="line"><span class="comment"> *  java.nio.channels.Channel 接口：</span></span><br><span class="line"><span class="comment"> *  |--FileChannel</span></span><br><span class="line"><span class="comment"> *  |--SocketChannel</span></span><br><span class="line"><span class="comment"> *  |--ServerSocketChannel</span></span><br><span class="line"><span class="comment"> *  |--DatagramChannel</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  三、获取通道</span></span><br><span class="line"><span class="comment"> *  1.java针对支持通道的类提供了getChannel()方法</span></span><br><span class="line"><span class="comment"> *  本地IO：</span></span><br><span class="line"><span class="comment"> *      FileInputStream/FileOutputStream</span></span><br><span class="line"><span class="comment"> *      RandomAccessFile</span></span><br><span class="line"><span class="comment"> *   网络IO：</span></span><br><span class="line"><span class="comment"> *      Socket</span></span><br><span class="line"><span class="comment"> *      ServerSocket</span></span><br><span class="line"><span class="comment"> *      DatagramSocket</span></span><br><span class="line"><span class="comment"> *   2.在JDK 1.7 中的NIO.2针对各个通道提供了静态方法open()</span></span><br><span class="line"><span class="comment"> *   3.在JDK 1.7 中的NIO.2的Files工具类的newByteChannel();</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p><strong>将Buffer 中数据写入Channel:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fisChannel.read(buffer)</span><br></pre></td></tr></table></figure>

<p><strong>从Channel 读取数据到Buffer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fosChannel.write(buffer);</span><br></pre></td></tr></table></figure>

<p><strong>demo</strong></p>
<p>==通过文件流的静态对象获取通道==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    FileChannel fisChannel = <span class="keyword">null</span>;</span><br><span class="line">    FileChannel fosChannel = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fis = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">&quot;1.jpg&quot;</span>));</span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(<span class="string">&quot;2.jpg&quot;</span>));</span><br><span class="line"></span><br><span class="line">        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        fisChannel = fis.getChannel();</span><br><span class="line">        fosChannel = fos.getChannel();</span><br><span class="line">        <span class="keyword">while</span> (fisChannel.read(buffer) != -<span class="number">1</span>) &#123;</span><br><span class="line">            buffer.flip();</span><br><span class="line">            fosChannel.write(buffer);</span><br><span class="line">            buffer.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        ;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fis!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fis.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">if</span> (fos!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fos.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">if</span> (fisChannel!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fisChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">if</span> (fosChannel!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fosChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>==通过各个通道提供的静态方法获取通道==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用直接缓冲区完成复制件(内存映射文件)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    FileChannel inChannel = FileChannel.open(Paths.get(<span class="string">&quot;1.jpg&quot;</span>), StandardOpenOption.READ);</span><br><span class="line">    FileChannel outChannel = FileChannel.open(Paths.get(<span class="string">&quot;3.jpg&quot;</span>),StandardOpenOption.WRITE,StandardOpenOption.READ,StandardOpenOption.CREATE);</span><br><span class="line">    <span class="comment">//内存映射文件</span></span><br><span class="line">    MappedByteBuffer inMappedBuf = inChannel.map(FileChannel.MapMode.READ_ONLY, <span class="number">0</span>, inChannel.size());</span><br><span class="line">    MappedByteBuffer outMappedBuf = outChannel.map(FileChannel.MapMode.READ_WRITE, <span class="number">0</span>, inChannel.size());</span><br><span class="line">    <span class="comment">//直接对缓冲区进行读写操作</span></span><br><span class="line">    <span class="keyword">byte</span>[] dst = <span class="keyword">new</span> <span class="keyword">byte</span>[inMappedBuf.limit()];</span><br><span class="line">    inMappedBuf.get(dst);</span><br><span class="line">    outMappedBuf.put(dst);</span><br><span class="line">    inChannel.close();</span><br><span class="line">    outChannel.close();;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>==通道间传输文件==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    FileChannel inChannel = FileChannel.open(Paths.get(<span class="string">&quot;1.jpg&quot;</span>), StandardOpenOption.READ);</span><br><span class="line">    FileChannel outChannel = FileChannel.open(Paths.get(<span class="string">&quot;3.jpg&quot;</span>),StandardOpenOption.WRITE,StandardOpenOption.READ,StandardOpenOption.CREATE);</span><br><span class="line">    <span class="comment">//通道直接传输文件</span></span><br><span class="line">    inChannel.transferTo(<span class="number">0</span>, inChannel.size(), outChannel);</span><br><span class="line">    <span class="comment">//关闭通道</span></span><br><span class="line">    inChannel.close();</span><br><span class="line">    outChannel.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分散与聚集"><a href="#分散与聚集" class="headerlink" title="分散与聚集"></a>分散与聚集</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*   五、分散（Scatter）与聚集（Gather）</span></span><br><span class="line"><span class="comment">*   分散读取（Scatter Readers）：将通道中的数据分散到多个缓冲区中</span></span><br><span class="line"><span class="comment">*   聚集写入（Gathering Writes）：将多个缓冲区的数据聚集到通道中</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/31/language/java/nio/image-20210101153002175.png" alt="image-20210101153002175"></p>
<p><img src="/2020/12/31/language/java/nio/image-20210101153018934.png" alt="image-20210101153018934"></p>
<p><strong>demo</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(<span class="string">&quot;1.txt&quot;</span>, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line"></span><br><span class="line">    FileChannel inChannel = raf.getChannel();</span><br><span class="line">    ByteBuffer buffer1 = ByteBuffer.allocate(<span class="number">100</span>);</span><br><span class="line">    ByteBuffer buffer2 = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">    <span class="comment">//分散读取</span></span><br><span class="line">    ByteBuffer[] dst = &#123;buffer1,buffer2&#125;;</span><br><span class="line">    inChannel.read(dst);</span><br><span class="line">    <span class="keyword">for</span> (ByteBuffer buf : dst)&#123;</span><br><span class="line">        buf.flip();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="keyword">new</span> String(dst[<span class="number">0</span>].array(),<span class="number">0</span>,dst[<span class="number">0</span>].limit()));</span><br><span class="line">    System.out.println(<span class="string">&quot;--------scatter------------&quot;</span>);</span><br><span class="line">    System.out.println(<span class="keyword">new</span> String(dst[<span class="number">1</span>].array(),<span class="number">0</span>,dst[<span class="number">1</span>].limit()));</span><br><span class="line">    <span class="comment">//聚集写入</span></span><br><span class="line">    RandomAccessFile raf2 = <span class="keyword">new</span> RandomAccessFile(<span class="string">&quot;2.txt&quot;</span>, <span class="string">&quot;rw&quot;</span>);</span><br><span class="line">    FileChannel raf2Channel = raf2.getChannel();</span><br><span class="line"></span><br><span class="line">    raf2Channel.write(dst);</span><br><span class="line"></span><br><span class="line">    raf2Channel.close();</span><br><span class="line">    raf2Channel.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="阻塞与非阻塞IO"><a href="#阻塞与非阻塞IO" class="headerlink" title="阻塞与非阻塞IO"></a>阻塞与非阻塞IO</h3><p><strong>阻塞式：</strong></p>
<p><strong>demo</strong></p>
<p>==client==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">client</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SocketChannel sChannel = SocketChannel.open(<span class="keyword">new</span> InetSocketAddress(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8989</span>));</span><br><span class="line"></span><br><span class="line">        FileChannel inChannel = FileChannel.open(Paths.get(<span class="string">&quot;1.jpg&quot;</span>), StandardOpenOption.READ);</span><br><span class="line"></span><br><span class="line">        ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">while</span> (inChannel.read(byteBuffer)!=-<span class="number">1</span>)&#123;</span><br><span class="line">            byteBuffer.flip();</span><br><span class="line">            sChannel.write(byteBuffer);</span><br><span class="line">            byteBuffer.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sChannel.shutdownOutput();</span><br><span class="line">        <span class="comment">//接收服务端的反馈</span></span><br><span class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((len = sChannel.read(byteBuffer))!=-<span class="number">1</span>)&#123;</span><br><span class="line">            byteBuffer.flip();</span><br><span class="line">            System.out.println(<span class="keyword">new</span> String(byteBuffer.array(),<span class="number">0</span>,len));</span><br><span class="line">        &#125;</span><br><span class="line">        sChannel.close();</span><br><span class="line">        inChannel.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>==server==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ServerSocketChannel ssChannel = ServerSocketChannel.open();</span><br><span class="line">    ssChannel.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">8989</span>));</span><br><span class="line"></span><br><span class="line">    SocketChannel sChannel = ssChannel.accept();</span><br><span class="line">    FileChannel outChannel = FileChannel.open(Paths.get(<span class="string">&quot;2.jpg&quot;</span>),StandardOpenOption.CREATE, StandardOpenOption.WRITE);</span><br><span class="line">    ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(sChannel.read(byteBuffer)!=-<span class="number">1</span>)&#123;</span><br><span class="line">        byteBuffer.flip();</span><br><span class="line">        outChannel.write(byteBuffer);</span><br><span class="line">        byteBuffer.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    byteBuffer.put(<span class="string">&quot;服务端接收到数据&quot;</span>.getBytes());</span><br><span class="line">    byteBuffer.flip();</span><br><span class="line">    sChannel.write(byteBuffer);</span><br><span class="line"></span><br><span class="line">    ssChannel.close();</span><br><span class="line">    sChannel.close();</span><br><span class="line">    outChannel.close();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="选择器"><a href="#选择器" class="headerlink" title="选择器"></a>选择器</h4><p><img src="/2020/12/31/language/java/nio/image-20210101192329945.png" alt="image-20210101192329945"></p>
<p><img src="/2020/12/31/language/java/nio/image-20210101192352833.png" alt="image-20210101192352833"></p>
<p><img src="/2020/12/31/language/java/nio/image-20210101192410805.png" alt="image-20210101192410805"></p>
<p><img src="/2020/12/31/language/java/nio/image-20210101192501591.png" alt="image-20210101192501591"></p>
<p><strong>demo</strong></p>
<p>==client==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    SocketChannel sChannel = SocketChannel.open(<span class="keyword">new</span> InetSocketAddress(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9898</span>));</span><br><span class="line">    <span class="comment">//切换成非阻塞式</span></span><br><span class="line">    sChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">    <span class="keyword">while</span> (scanner.hasNext())&#123;</span><br><span class="line">        String next = scanner.next();</span><br><span class="line">        byteBuffer.put((LocalDateTime.now()+<span class="string">&quot;\n&quot;</span> +next).getBytes());</span><br><span class="line">        byteBuffer.flip();</span><br><span class="line">        sChannel.write(byteBuffer);</span><br><span class="line">        byteBuffer.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    sChannel.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>==server==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//1.获取通道</span></span><br><span class="line">    ServerSocketChannel ssChannel = ServerSocketChannel.open();</span><br><span class="line">    <span class="comment">//2.切换成非阻塞式的</span></span><br><span class="line">    ssChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">//3.绑定连接</span></span><br><span class="line">    ssChannel.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">9898</span>));</span><br><span class="line">    <span class="comment">//4.获取选择器</span></span><br><span class="line">    Selector selector = Selector.open();</span><br><span class="line">    <span class="comment">//5.将通道注册在选择器上面</span></span><br><span class="line">    ssChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">    <span class="comment">//6.轮询式的获取选择器上面已经准备就绪的事件</span></span><br><span class="line">    <span class="keyword">while</span> (selector.select()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//7.获取当前选择器中所有注册的“选择键（已就绪的事件）”</span></span><br><span class="line">        Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">            <span class="comment">//8.获取准备就绪的事件</span></span><br><span class="line">            SelectionKey selectionKey = iterator.next();</span><br><span class="line">            <span class="comment">//9.具体判断是什么事件准备就绪</span></span><br><span class="line">            <span class="keyword">if</span> (selectionKey.isAcceptable())&#123;</span><br><span class="line">                <span class="comment">//10.若“接受就绪”，获取客户端连接</span></span><br><span class="line">                SocketChannel sChannel = ssChannel.accept();</span><br><span class="line">                <span class="comment">//11.切换成非阻塞模式</span></span><br><span class="line">                sChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                <span class="comment">//12.将该通道注册到选择器上</span></span><br><span class="line">                sChannel.register(selector,SelectionKey.OP_READ);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (selectionKey.isReadable())&#123;</span><br><span class="line">                <span class="comment">//13.获取当前选择器上“读就绪”状态的通道</span></span><br><span class="line">                SocketChannel selectableChannel = (SocketChannel) selectionKey.channel();</span><br><span class="line">                <span class="comment">//14.读数据</span></span><br><span class="line">                ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                <span class="comment">//print</span></span><br><span class="line">                <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> ((len = selectableChannel.read(byteBuffer))&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                    byteBuffer.flip();</span><br><span class="line">                    System.out.println(<span class="keyword">new</span> String(byteBuffer.array(),<span class="number">0</span>,len));</span><br><span class="line">                    byteBuffer.clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//15.取消选择键SelectionKey</span></span><br><span class="line">            iterator.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="管道java"><a href="#管道java" class="headerlink" title="管道java"></a>管道java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Pipe pipe = Pipe.open();</span><br><span class="line"></span><br><span class="line">    Pipe.SinkChannel sinkChannel = pipe.sink();</span><br><span class="line"></span><br><span class="line">    ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    byteBuffer.put(<span class="string">&quot;test Pipe send message&quot;</span>.getBytes());</span><br><span class="line">    byteBuffer.flip();</span><br><span class="line"></span><br><span class="line">    sinkChannel.write(byteBuffer);</span><br><span class="line"></span><br><span class="line">    Pipe.SourceChannel sourceChannel = pipe.source();</span><br><span class="line"></span><br><span class="line">    byteBuffer.clear();</span><br><span class="line">    sourceChannel.read(byteBuffer);</span><br><span class="line"></span><br><span class="line">    byteBuffer.flip();</span><br><span class="line">    System.out.println(<span class="keyword">new</span> String(byteBuffer.array(),<span class="number">0</span>,byteBuffer.limit()));</span><br><span class="line"></span><br><span class="line">    sinkChannel.close();</span><br><span class="line">    sourceChannel.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/28/assist/assistdev/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LZ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/28/assist/assistdev/" class="post-title-link" itemprop="url">AssistDev</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-28 20:47:57" itemprop="dateCreated datePublished" datetime="2020-12-28T20:47:57+08:00">2020-12-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-30 15:16:32" itemprop="dateModified" datetime="2020-12-30T15:16:32+08:00">2020-12-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8D%8F%E5%8A%A9%E5%BC%80%E5%8F%91/" itemprop="url" rel="index"><span itemprop="name">协助开发</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h1><h2 id="命令行操作"><a href="#命令行操作" class="headerlink" title="命令行操作"></a>命令行操作</h2><h3 id="设置签名"><a href="#设置签名" class="headerlink" title="设置签名"></a>设置签名</h3><p><strong>形式：</strong>用户名 邮箱</p>
<p><strong>作用：</strong>区分不同开发人员的身份</p>
<p><strong>辨析：</strong>这里设置的签名和登录远程库(代码托管中心)的账号、密码没有任何关系。</p>
<p><strong>命令：</strong></p>
<ul>
<li><p>项目级别/仓库级别：尽在当前本地库有效</p>
<ol>
<li>​    <code>git config user.name lz</code></li>
<li>​    <code>git config user.email lz@123.com</code></li>
<li>信息保存位置：./git/config</li>
</ol>
</li>
<li><p>系统用户级别：登录当前操作系统的用户范围</p>
<ol>
<li>​    <code>git config --global user.name lz</code></li>
<li>​    <code>git config --global user.email lz@123.com lz@123.com</code></li>
<li>信息保存位置：~/.gitconfig</li>
</ol>
</li>
<li><p>级别优先级</p>
<ul>
<li>就近原则：项目级别优先于系统用户级别，二者都有时采用项目级别的签名</li>
<li>如果只有系统用户级别的签名，就以系统用户级别的签名为准</li>
<li>二者都没有不允许</li>
</ul>
</li>
</ul>
<h3 id="一些基本的命令"><a href="#一些基本的命令" class="headerlink" title="一些基本的命令"></a>一些基本的命令</h3><h4 id="撤销add操作"><a href="#撤销add操作" class="headerlink" title="撤销add操作"></a>撤销add操作</h4><p><code>git rm --cached &lt;file&gt;</code></p>
<h4 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h4><p>将日志在一行显示：<code>git log --pretty=oneline</code></p>
<p>简短显示(缩短hash值)：<code>git log --oneline</code></p>
<p><img src="/2020/12/28/assist/assistdev/image-20201228221437437.png" alt="image-20201228221437437"></p>
<p>前进后退移动指针步数可显示：<code>git reflog</code></p>
<p><img src="/2020/12/28/assist/assistdev/image-20201228221521040.png" alt="image-20201228221521040"></p>
<p>HEAD@{移动到当前版本需要多少步}</p>
<h4 id="版本前进后退"><a href="#版本前进后退" class="headerlink" title="版本前进后退"></a>版本前进后退</h4><p>基于索引值操作（推荐）<code>git reset --hard[局部索引值]</code></p>
<p><img src="/2020/12/28/assist/assistdev/image-20201228222818802.png" alt="image-20201228222818802"></p>
<p>使用^符号：只能后退  <code>git reset --hard HEAD^</code></p>
<p>使用<del>符号：只能后退  `git reset –hard HEAD</del>n`</p>
<p><strong>revert</strong></p>
<ul>
<li><code>git revert -n [hash值]</code> </li>
<li>编辑</li>
<li><code>git add</code></li>
<li><code>git commit -m&quot;&quot;</code></li>
</ul>
<h4 id="reset3个参数区别"><a href="#reset3个参数区别" class="headerlink" title="reset3个参数区别"></a>reset3个参数区别</h4><p>–soft </p>
<ul>
<li>尽在本地库移动HEAD指针</li>
</ul>
<p><img src="/2020/12/28/assist/assistdev/image-20201228223718338.png" alt="image-20201228223718338"></p>
<p>–mixed参数</p>
<ul>
<li>在本地库移动HEAD指针</li>
<li>重置暂存区</li>
</ul>
<p><img src="/2020/12/28/assist/assistdev/image-20201228223812249.png" alt="image-20201228223812249"></p>
<p>–hard参数</p>
<ul>
<li>在本地库移动HEAD指针</li>
<li>重置暂存区</li>
<li>重置工作区</li>
</ul>
<p><img src="/2020/12/28/assist/assistdev/image-20201228223855475.png" alt="image-20201228223855475"></p>
<h4 id="找回已删除文件"><a href="#找回已删除文件" class="headerlink" title="找回已删除文件"></a>找回已删除文件</h4><ul>
<li>前提：删除前，文件存在时的状态提交到了本地库</li>
<li>操作：<code>git reset --hard [指针位置]</code><ol>
<li>​    删除前已经提交到本地库：指针指向历史记录</li>
<li>​    删除前没有提交到本地库：指针位置使用HEAD</li>
</ol>
</li>
</ul>
<h4 id="比较文件差异"><a href="#比较文件差异" class="headerlink" title="比较文件差异"></a>比较文件差异</h4><ul>
<li><p>将工作区中的文件和暂存区进行比较 <code>git diff[文件名]</code></p>
</li>
<li><p>将工作区中的文件和本地库历史记录比较 <code>git diff[本地库中历史版本][文件名]</code></p>
</li>
<li><p>不带文件名比较多个文件</p>
</li>
</ul>
<h4 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h4><ol>
<li>创建分支：<code>git branch [分支名]</code></li>
<li>查看分支：<code>git branch -v</code></li>
<li>切换分支：<code>git checkout [分支名]</code></li>
<li>合并分支：<ul>
<li>切换到接受修改的分支    <code>git checkout [被合并分支]</code></li>
<li>执行merge命令    <code>git merge [有新内容的分支]</code></li>
</ul>
</li>
<li>解决冲突：<ul>
<li>​    表现：<img src="/2020/12/28/assist/assistdev/image-20201230101801943.png" alt="image-20201230101801943"></li>
<li>冲突的解决：<ul>
<li>编辑文件，删除特殊符号</li>
<li>修改文件</li>
<li>git add [文件名]</li>
<li>git commit -m “日志信息”</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="拉取（fetch）"><a href="#拉取（fetch）" class="headerlink" title="拉取（fetch）"></a><strong>拉取（fetch）</strong></h4><ul>
<li>pull = fetch+merge</li>
<li>git fetch [远程仓库别名] [远程分支名]</li>
<li>git merge [远程仓库别名/远程分支名]</li>
<li>git pull [远程仓库别名] [远程分支名] </li>
</ul>
<p><img src="/2020/12/28/assist/assistdev/image-20201230112512093.png" alt="image-20201230112512093"></p>
<p><img src="/2020/12/28/assist/assistdev/image-20201230112546602.png" alt="image-20201230112546602"></p>
<h3 id="Git保存版本的机制"><a href="#Git保存版本的机制" class="headerlink" title="Git保存版本的机制"></a>Git保存版本的机制</h3><p><strong>1集中式版本控制工具的文件管理机制</strong></p>
<p>==增量式==</p>
<p>以文件变更列表的方式存储信息。这类系统将它们保存的信息看作是一组基本文件和每个文件随时间逐步累积的差异。</p>
<p><img src="/2020/12/28/assist/assistdev/image-20201230103357086.png" alt="image-20201230103357086"></p>
<p><strong>2Git的文件管理机制</strong></p>
<p>Git把数据看作是小型文件系统的一组快照。每次提交更新时Git都会对<strong>当前的全部文件制作一个快照</strong>并保存这个快照的索引。为了高效，如果文件没有修改，Git不再重新存储该文件，而是只保留一个链接指向之前存储的文件。所以G<strong>it的工作方式可以称之为快照流。</strong></p>
<p><img src="/2020/12/28/assist/assistdev/image-20201230103516097.png" alt="image-20201230103516097"></p>
<p><strong>3Git**</strong>文件管理机制细节**</p>
<ul>
<li>git的“提交对象”</li>
</ul>
<p><img src="/2020/12/28/assist/assistdev/image-20201230103721523.png" alt="image-20201230103721523"></p>
<p><img src="/2020/12/28/assist/assistdev/image-20201230103735345.png" alt="image-20201230103735345"></p>
<h3 id="Git分支管理机制"><a href="#Git分支管理机制" class="headerlink" title="Git分支管理机制"></a>Git分支管理机制</h3><p><img src="/2020/12/28/assist/assistdev/image-20201230103814695.png" alt="image-20201230103814695"></p>
<p><img src="/2020/12/28/assist/assistdev/image-20201230103830333.png" alt="image-20201230103830333"></p>
<p><img src="/2020/12/28/assist/assistdev/image-20201230103911115.png" alt="image-20201230103911115"></p>
<p><img src="/2020/12/28/assist/assistdev/image-20201230103934016.png" alt="image-20201230103934016"></p>
<p><strong>ps:</strong></p>
<p>win10有个凭据管理器可以记住密码</p>
<p><img src="/2020/12/28/assist/assistdev/image-20201230105347156.png" alt="image-20201230105347156"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/17/framework/shiro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LZ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/17/framework/shiro/" class="post-title-link" itemprop="url">Shiro</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-17 19:59:18" itemprop="dateCreated datePublished" datetime="2020-12-17T19:59:18+08:00">2020-12-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-19 17:02:51" itemprop="dateModified" datetime="2020-12-19T17:02:51+08:00">2020-12-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.crazycake/shiro-redis --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.crazycake<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><h2 id="Realm关系图"><a href="#Realm关系图" class="headerlink" title="Realm关系图"></a>Realm关系图</h2><p><img src="/2020/12/17/framework/shiro/image-20201217210227369.png" alt="image-20201217210227369"></p>
<p>==主要实现==</p>
<p><img src="/2020/12/17/framework/shiro/image-20201217210317784.png" alt="image-20201217210317784"></p>
<h2 id="数据库表关系"><a href="#数据库表关系" class="headerlink" title="数据库表关系"></a>数据库表关系</h2><p><img src="/2020/12/17/framework/shiro/image-20201219005429086.png" alt="image-20201219005429086"></p>
<h1 id="主要配置"><a href="#主要配置" class="headerlink" title="主要配置"></a>主要配置</h1><h2 id="ShiroConfig"><a href="#ShiroConfig" class="headerlink" title="ShiroConfig"></a>ShiroConfig</h2><p><strong>主要参数</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//password-encrypt</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;project.password.encrypt.algorithm&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String algorithm;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;project.password.encrypt.hashIterations&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String hashIterations;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//redis profile</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.host&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ShiroFilterFactoryBean"><a href="#ShiroFilterFactoryBean" class="headerlink" title="ShiroFilterFactoryBean"></a>ShiroFilterFactoryBean</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">(DefaultWebSecurityManager defaultWebSecurityManager)</span></span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line"></span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(defaultWebSecurityManager);</span><br><span class="line"></span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/unAuthorized&quot;</span>);</span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/toLogin&quot;</span>);</span><br><span class="line">        shiroFilterFactoryBean.setSuccessUrl(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">        LinkedHashMap&lt;String, Filter&gt; filtersMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        filtersMap.put(&quot;kickout&quot;,new KickoutFilter());</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        shiroFilterFactoryBean.setFilters(filtersMap);</span></span><br><span class="line"></span><br><span class="line">        LinkedHashMap&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line"></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/js/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/image/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/druid/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//放行Swagger接口</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/swagger**/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/v3/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/webjars/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/doc.html&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        <span class="comment">//logout是Shiro提供的过滤器</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/logout&quot;</span>,<span class="string">&quot;logout&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//其他资源都需要认证</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>,<span class="string">&quot;authc&quot;</span>);</span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="DefaultWebSecurityManager"><a href="#DefaultWebSecurityManager" class="headerlink" title="DefaultWebSecurityManager"></a>DefaultWebSecurityManager</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">    public DefaultWebSecurityManager defaultWebSecurityManager(ShiroRealm shiroRealm)&#123;</span><br><span class="line"></span><br><span class="line">        DefaultWebSecurityManager securityManage &#x3D; new DefaultWebSecurityManager();</span><br><span class="line">        securityManage.setRealm(shiroRealm);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;记住我</span><br><span class="line">&#x2F;&#x2F;        securityManage.setRememberMeManager(rememberMeManager());</span><br><span class="line"></span><br><span class="line">        securityManage.setSessionManager(sessionManager());</span><br><span class="line"></span><br><span class="line">        securityManage.setCacheManager(redisCacheManager());</span><br><span class="line"></span><br><span class="line">        return securityManage;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Realm"><a href="#Realm" class="headerlink" title="Realm"></a>Realm</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroRealm <span class="title">shiroRealm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ShiroRealm shiroRealm = <span class="keyword">new</span> ShiroRealm();</span><br><span class="line">        shiroRealm.setCredentialsMatcher(hashedCredentialsMatcher());</span><br><span class="line">        shiroRealm.setCachingEnabled(<span class="keyword">true</span>);</span><br><span class="line">        shiroRealm.setAuthorizationCachingEnabled(<span class="keyword">true</span>);</span><br><span class="line">        shiroRealm.setAuthorizationCacheName(<span class="string">&quot;authorizationCache&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> shiroRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashedCredentialsMatcher <span class="title">hashedCredentialsMatcher</span><span class="params">()</span></span>&#123;</span><br><span class="line">        HashedCredentialsMatcher credentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher();</span><br><span class="line">        credentialsMatcher.setHashAlgorithmName(algorithm);</span><br><span class="line">        credentialsMatcher.setHashIterations(Integer.valueOf(hashIterations));</span><br><span class="line">        credentialsMatcher.setStoredCredentialsHexEncoded(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> credentialsMatcher;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Session管理"><a href="#Session管理" class="headerlink" title="Session管理"></a>Session管理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionManager <span class="title">sessionManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultWebSessionManager defaultWebSessionManager = <span class="keyword">new</span> DefaultWebSessionManager();</span><br><span class="line">        defaultWebSessionManager.setCacheManager(redisCacheManager());</span><br><span class="line">        defaultWebSessionManager.setSessionDAO(redisSessionDao());</span><br><span class="line">        defaultWebSessionManager.setGlobalSessionTimeout(<span class="number">30</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//是否开启删除无效的session对象 默认为true</span></span><br><span class="line">        defaultWebSessionManager.setDeleteInvalidSessions(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//是否开启开启定时调度器检测过期session 默认为true</span></span><br><span class="line">        defaultWebSessionManager.setSessionValidationSchedulerEnabled(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//设置session失效的扫描时间，清理用户直接关闭浏览器造成的孤立会话 默认为1小时</span></span><br><span class="line">        defaultWebSessionManager.setSessionValidationInterval(<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">//取消url后面的jSessionId</span></span><br><span class="line">        defaultWebSessionManager.setSessionIdUrlRewritingEnabled(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultWebSessionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">redisCacheManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedisCacheManager redisCacheManager = <span class="keyword">new</span> RedisCacheManager();</span><br><span class="line">        redisCacheManager.setRedisManager(redisManager());</span><br><span class="line">        redisCacheManager.setExpire(<span class="number">30</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>);</span><br><span class="line">        <span class="keyword">return</span> redisCacheManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionIdGenerator <span class="title">sessionIdGenerator</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JavaUuidEditSessionIdGenerator();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionDAO <span class="title">redisSessionDao</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedisSessionDAO redisSessionDAO = <span class="keyword">new</span> RedisSessionDAO();</span><br><span class="line">        redisSessionDAO.setKeyPrefix(<span class="string">&quot;shiro:session:&quot;</span>);</span><br><span class="line">        redisSessionDAO.setSessionIdGenerator(sessionIdGenerator());</span><br><span class="line">        redisSessionDAO.setRedisManager(redisManager());</span><br><span class="line">        <span class="keyword">return</span> redisSessionDAO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisManager <span class="title">redisManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedisManager redisManager = <span class="keyword">new</span> RedisManager();</span><br><span class="line">        host+=<span class="string">&quot;:&quot;</span>+port;</span><br><span class="line">        redisManager.setHost(host);</span><br><span class="line">        redisManager.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> redisManager;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Remember功能"><a href="#Remember功能" class="headerlink" title="Remember功能"></a>Remember功能</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleCookie <span class="title">rememberCookie</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SimpleCookie simpleCookie = <span class="keyword">new</span> SimpleCookie();</span><br><span class="line">        simpleCookie.setHttpOnly(<span class="keyword">true</span>);</span><br><span class="line">        simpleCookie.setMaxAge(<span class="number">30</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>);</span><br><span class="line">        <span class="keyword">return</span> simpleCookie;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CookieRememberMeManager <span class="title">rememberMeManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        CookieRememberMeManager cookieRememberMeManager = <span class="keyword">new</span> CookieRememberMeManager();</span><br><span class="line">        cookieRememberMeManager.setCookie(rememberCookie());</span><br><span class="line">        <span class="comment">//rememberMe cookie加密的密钥 建议每个项目都不一样 默认AES算法 密钥长度(128 256 512 位)</span></span><br><span class="line">        cookieRememberMeManager.setEncryptionCipherKey(Base64.decode(<span class="string">&quot;4AvVhmFLUs0KTA3Kprsdag==&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> cookieRememberMeManager;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * FormAuthenticationFilter 过滤器 过滤记住我</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FormAuthenticationFilter <span class="title">formAuthenticationFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FormAuthenticationFilter formAuthenticationFilter = <span class="keyword">new</span> FormAuthenticationFilter();</span><br><span class="line">        <span class="comment">//对应前端的checkbox的name = rememberMe</span></span><br><span class="line">        formAuthenticationFilter.setRememberMeParam(<span class="string">&quot;rememberMe&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> formAuthenticationFilter;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加注解支持"><a href="#添加注解支持" class="headerlink" title="添加注解支持"></a>添加注解支持</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加注解支持</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title">defaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        <span class="comment">// 强制使用cglib，防止重复代理和可能引起代理出错的问题</span></span><br><span class="line">        defaultAdvisorAutoProxyCreator.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultAdvisorAutoProxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">authorizationAttributeSourceAdvisor</span><span class="params">(DefaultWebSecurityManager defaultWebSecurityManager)</span> </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor advisor = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        advisor.setSecurityManager(defaultWebSecurityManager);</span><br><span class="line">        <span class="keyword">return</span> advisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LifecycleBeanPostProcessor <span class="title">lifecycleBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifecycleBeanPostProcessor();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lz.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lz.componment.JavaUuidEditSessionIdGenerator;</span><br><span class="line"><span class="keyword">import</span> com.lz.realm.ShiroRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.CacheManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.SessionManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.eis.SessionDAO;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.eis.SessionIdGenerator;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authc.FormAuthenticationFilter;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.CookieRememberMeManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.SimpleCookie;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.session.mgt.DefaultWebSessionManager;</span><br><span class="line"><span class="keyword">import</span> org.crazycake.shiro.RedisCacheManager;</span><br><span class="line"><span class="keyword">import</span> org.crazycake.shiro.RedisManager;</span><br><span class="line"><span class="keyword">import</span> org.crazycake.shiro.RedisSessionDAO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 乐。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//password-encrypt</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;project.password.encrypt.algorithm&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String algorithm;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;project.password.encrypt.hashIterations&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String hashIterations;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//redis profile</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.host&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.redis.password&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">(DefaultWebSecurityManager defaultWebSecurityManager)</span></span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line"></span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(defaultWebSecurityManager);</span><br><span class="line"></span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">&quot;/unAuthorized&quot;</span>);</span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/toLogin&quot;</span>);</span><br><span class="line">        shiroFilterFactoryBean.setSuccessUrl(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">        LinkedHashMap&lt;String, Filter&gt; filtersMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        filtersMap.put(&quot;kickout&quot;,new KickoutFilter());</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        shiroFilterFactoryBean.setFilters(filtersMap);</span></span><br><span class="line"></span><br><span class="line">        LinkedHashMap&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line"></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/js/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/image/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/druid/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//放行Swagger接口</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/swagger**/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/v3/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/webjars/**&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/doc.html&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        <span class="comment">//logout是Shiro提供的过滤器</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/logout&quot;</span>,<span class="string">&quot;logout&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//其他资源都需要认证</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">&quot;/**&quot;</span>,<span class="string">&quot;authc&quot;</span>);</span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">defaultWebSecurityManager</span><span class="params">(ShiroRealm shiroRealm)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        DefaultWebSecurityManager securityManage = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        securityManage.setRealm(shiroRealm);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//记住我</span></span><br><span class="line"><span class="comment">//        securityManage.setRememberMeManager(rememberMeManager());</span></span><br><span class="line"></span><br><span class="line">        securityManage.setSessionManager(sessionManager());</span><br><span class="line"></span><br><span class="line">        securityManage.setCacheManager(redisCacheManager());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> securityManage;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroRealm <span class="title">shiroRealm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ShiroRealm shiroRealm = <span class="keyword">new</span> ShiroRealm();</span><br><span class="line">        shiroRealm.setCredentialsMatcher(hashedCredentialsMatcher());</span><br><span class="line">        shiroRealm.setCachingEnabled(<span class="keyword">true</span>);</span><br><span class="line">        shiroRealm.setAuthorizationCachingEnabled(<span class="keyword">true</span>);</span><br><span class="line">        shiroRealm.setAuthorizationCacheName(<span class="string">&quot;authorizationCache&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> shiroRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashedCredentialsMatcher <span class="title">hashedCredentialsMatcher</span><span class="params">()</span></span>&#123;</span><br><span class="line">        HashedCredentialsMatcher credentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher();</span><br><span class="line">        credentialsMatcher.setHashAlgorithmName(algorithm);</span><br><span class="line">        credentialsMatcher.setHashIterations(Integer.valueOf(hashIterations));</span><br><span class="line">        credentialsMatcher.setStoredCredentialsHexEncoded(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> credentialsMatcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionManager <span class="title">sessionManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultWebSessionManager defaultWebSessionManager = <span class="keyword">new</span> DefaultWebSessionManager();</span><br><span class="line">        defaultWebSessionManager.setCacheManager(redisCacheManager());</span><br><span class="line">        defaultWebSessionManager.setSessionDAO(redisSessionDao());</span><br><span class="line">        defaultWebSessionManager.setGlobalSessionTimeout(<span class="number">30</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//是否开启删除无效的session对象 默认为true</span></span><br><span class="line">        defaultWebSessionManager.setDeleteInvalidSessions(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//是否开启开启定时调度器检测过期session 默认为true</span></span><br><span class="line">        defaultWebSessionManager.setSessionValidationSchedulerEnabled(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//设置session失效的扫描时间，清理用户直接关闭浏览器造成的孤立会话 默认为1小时</span></span><br><span class="line">        defaultWebSessionManager.setSessionValidationInterval(<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">//取消url后面的jSessionId</span></span><br><span class="line">        defaultWebSessionManager.setSessionIdUrlRewritingEnabled(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultWebSessionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">redisCacheManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedisCacheManager redisCacheManager = <span class="keyword">new</span> RedisCacheManager();</span><br><span class="line">        redisCacheManager.setRedisManager(redisManager());</span><br><span class="line">        redisCacheManager.setExpire(<span class="number">30</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>);</span><br><span class="line">        <span class="keyword">return</span> redisCacheManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionIdGenerator <span class="title">sessionIdGenerator</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JavaUuidEditSessionIdGenerator();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SessionDAO <span class="title">redisSessionDao</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedisSessionDAO redisSessionDAO = <span class="keyword">new</span> RedisSessionDAO();</span><br><span class="line">        redisSessionDAO.setKeyPrefix(<span class="string">&quot;shiro:session:&quot;</span>);</span><br><span class="line">        redisSessionDAO.setSessionIdGenerator(sessionIdGenerator());</span><br><span class="line">        redisSessionDAO.setRedisManager(redisManager());</span><br><span class="line">        <span class="keyword">return</span> redisSessionDAO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisManager <span class="title">redisManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        RedisManager redisManager = <span class="keyword">new</span> RedisManager();</span><br><span class="line">        host+=<span class="string">&quot;:&quot;</span>+port;</span><br><span class="line">        redisManager.setHost(host);</span><br><span class="line">        redisManager.setPassword(password);</span><br><span class="line">        <span class="keyword">return</span> redisManager;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleCookie <span class="title">rememberCookie</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SimpleCookie simpleCookie = <span class="keyword">new</span> SimpleCookie();</span><br><span class="line">        simpleCookie.setHttpOnly(<span class="keyword">true</span>);</span><br><span class="line">        simpleCookie.setMaxAge(<span class="number">30</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>);</span><br><span class="line">        <span class="keyword">return</span> simpleCookie;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CookieRememberMeManager <span class="title">rememberMeManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        CookieRememberMeManager cookieRememberMeManager = <span class="keyword">new</span> CookieRememberMeManager();</span><br><span class="line">        cookieRememberMeManager.setCookie(rememberCookie());</span><br><span class="line">        <span class="comment">//rememberMe cookie加密的密钥 建议每个项目都不一样 默认AES算法 密钥长度(128 256 512 位)</span></span><br><span class="line">        cookieRememberMeManager.setEncryptionCipherKey(Base64.decode(<span class="string">&quot;4AvVhmFLUs0KTA3Kprsdag==&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> cookieRememberMeManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * FormAuthenticationFilter 过滤器 过滤记住我</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FormAuthenticationFilter <span class="title">formAuthenticationFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FormAuthenticationFilter formAuthenticationFilter = <span class="keyword">new</span> FormAuthenticationFilter();</span><br><span class="line">        <span class="comment">//对应前端的checkbox的name = rememberMe</span></span><br><span class="line">        formAuthenticationFilter.setRememberMeParam(<span class="string">&quot;rememberMe&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> formAuthenticationFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加注解支持</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title">defaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultAdvisorAutoProxyCreator defaultAdvisorAutoProxyCreator = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator();</span><br><span class="line">        <span class="comment">// 强制使用cglib，防止重复代理和可能引起代理出错的问题</span></span><br><span class="line">        defaultAdvisorAutoProxyCreator.setProxyTargetClass(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultAdvisorAutoProxyCreator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">authorizationAttributeSourceAdvisor</span><span class="params">(DefaultWebSecurityManager defaultWebSecurityManager)</span> </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor advisor = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        advisor.setSecurityManager(defaultWebSecurityManager);</span><br><span class="line">        <span class="keyword">return</span> advisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LifecycleBeanPostProcessor <span class="title">lifecycleBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifecycleBeanPostProcessor();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ShiroRealm"><a href="#ShiroRealm" class="headerlink" title="ShiroRealm"></a>ShiroRealm</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lz.realm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.lz.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.lz.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 乐。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserService userService;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        SimpleAuthorizationInfo simpleAuthorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line"></span><br><span class="line">        String userName = (String) principalCollection.getPrimaryPrincipal();</span><br><span class="line"></span><br><span class="line">        User userInfo = userService.getByUserName(userName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(userInfo!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            simpleAuthorizationInfo.addRole(userInfo.getRole());</span><br><span class="line"></span><br><span class="line">            simpleAuthorizationInfo.addStringPermission(userInfo.getPerms());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> simpleAuthorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) authenticationToken;</span><br><span class="line">        String username = usernamePasswordToken.getUsername();</span><br><span class="line">        String password = <span class="keyword">new</span> String (usernamePasswordToken.getPassword());</span><br><span class="line"></span><br><span class="line">        User userInfo = userService.getByUserName(username);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(userInfo == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">&quot;用户名或者密码错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SimpleAuthenticationInfo simpleAuthenticationInfo = <span class="keyword">new</span> SimpleAuthenticationInfo(username,userInfo.getPassword(), ByteSource.Util.bytes(username),getName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> simpleAuthenticationInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h1><h2 id="自定义SessionManager"><a href="#自定义SessionManager" class="headerlink" title="自定义SessionManager"></a>自定义SessionManager</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lz.componment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.Session;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.UnknownSessionException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.SessionKey;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.ShiroHttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.session.mgt.DefaultWebSessionManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.session.mgt.WebSessionKey;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.util.WebUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 乐。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroWebSessionManager</span> <span class="keyword">extends</span> <span class="title">DefaultWebSessionManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORIZATION=<span class="string">&quot;token&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REFERENCED_SESSION_ID_SOURCE=<span class="string">&quot;header&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ShiroWebSessionManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Serializable <span class="title">getSessionId</span><span class="params">(ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String id = WebUtils.toHttp(request).getHeader(AUTHORIZATION);</span><br><span class="line">        <span class="comment">//如果请求头中有Authorization,则其值为SessionId</span></span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.isBlank(id))&#123;</span><br><span class="line">            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_SOURCE, REFERENCED_SESSION_ID_SOURCE);</span><br><span class="line">            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID, id);</span><br><span class="line">            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_IS_VALID, Boolean.TRUE);</span><br><span class="line">            <span class="keyword">return</span> id;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//否则按默认规则取sessionId</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getSessionId(request,response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取session</span></span><br><span class="line"><span class="comment">     * 优化单次请求需要多次访问redis问题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sessionKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UnknownSessionException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Session <span class="title">retrieveSession</span><span class="params">(SessionKey sessionKey)</span> <span class="keyword">throws</span> UnknownSessionException </span>&#123;</span><br><span class="line">        Serializable sessionId = getSessionId(sessionKey);</span><br><span class="line"></span><br><span class="line">        ServletRequest request = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(sessionKey <span class="keyword">instanceof</span> WebSessionKey)&#123;</span><br><span class="line">            request = ((WebSessionKey) sessionKey).getServletRequest();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(request!=<span class="keyword">null</span> &amp;&amp; <span class="keyword">null</span> != sessionId)&#123;</span><br><span class="line">            Object sessionObj = request.getAttribute(sessionId.toString());</span><br><span class="line">            <span class="keyword">if</span>(sessionObj!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;read session from request&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> (Session) sessionObj;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Session session = <span class="keyword">super</span>.retrieveSession(sessionKey);</span><br><span class="line">        <span class="keyword">if</span>(request!=<span class="keyword">null</span> &amp;&amp; <span class="keyword">null</span> != sessionId)&#123;</span><br><span class="line">            request.setAttribute(sessionId.toString(),session);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="自定义SessionId"><a href="#自定义SessionId" class="headerlink" title="自定义SessionId"></a>自定义SessionId</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lz.componment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.Session;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.eis.SessionIdGenerator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 乐。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaUuidEditSessionIdGenerator</span> <span class="keyword">implements</span> <span class="title">SessionIdGenerator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JavaUuidEditSessionIdGenerator</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Serializable <span class="title">generateId</span><span class="params">(Session session)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="密码加密"><a href="#密码加密" class="headerlink" title="密码加密"></a>密码加密</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lz.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.SimpleHash;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 乐。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;project.password.encrypt.algorithm&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String algorithm;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;project.password.encrypt.hashIterations&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String hashIterations;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">md5</span><span class="params">(String password,String salt)</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SimpleHash(algorithm,password, ByteSource.Util.bytes(salt),Integer.valueOf(hashIterations))</span><br><span class="line">               .toHex();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h1><p>==shiro权限注解==</p>
<p>Shiro 提供了相应的注解用于权限控制，如果使用这些注解就需要使用AOP 的功能来进行判断，如Spring AOP；Shiro 提供了Spring AOP 集成用于权限注解的解析和验证。</p>
<p><code>@RequiresAuthentication</code> 表示当前Subject已经通过login 进行了身份验证；即Subject.isAuthenticated()返回true。</p>
<p><code>@RequiresUser</code> 表示当前Subject已经身份验证或者通过记住我登录的。</p>
<p><code>@RequiresGuest</code> 表示当前Subject没有身份验证或通过记住我登录过，即是游客身份。</p>
<p><code>@RequiresRoles(value=&#123;&quot;admin&quot;, &quot;user&quot;&#125;, logical= Logical.AND)</code> <code>@RequiresRoles(value=&#123;&quot;admin&quot;&#125;)</code> <code>@RequiresRoles(&#123;&quot;admin&quot;&#125;)</code> 表示当前Subject需要角色admin 和user。</p>
<p><code>@RequiresPermissions(value=&#123;&quot;user:a&quot;, &quot;user:b&quot;&#125;, logical= Logical.OR)</code> 表示当前Subject需要权限user:a或user:b。</p>
<p><strong>Shiro的认证注解处理是有内定的处理顺序的</strong>，如果有多个注解的话，前面的通过了会继续检查后面的，若不通过则直接返回，<strong>处理顺序依次为</strong>（<strong>与实际声明顺序无关</strong>）：</p>
<ul>
<li>RequiresRoles</li>
<li>RequiresPermissions</li>
<li>RequiresAuthentication</li>
<li>RequiresUser</li>
<li>RequiresGuest</li>
</ul>
<p>以上注解既可以用在controller中，也可以用在service中使用； 建议将shiro注解放在controller中，因为如果service层使用了spring的事物注解，那么shiro注解将无效</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/12/17/%E9%98%BF%E9%87%8C%E4%BA%91/aliyun/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LZ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/17/%E9%98%BF%E9%87%8C%E4%BA%91/aliyun/" class="post-title-link" itemprop="url">aliyun</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-17 19:48:51" itemprop="dateCreated datePublished" datetime="2020-12-17T19:48:51+08:00">2020-12-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-25 19:22:21" itemprop="dateModified" datetime="2020-12-25T19:22:21+08:00">2020-12-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%98%BF%E9%87%8C%E4%BA%91/" itemprop="url" rel="index"><span itemprop="name">阿里云</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="OSS对象存储"><a href="#OSS对象存储" class="headerlink" title="OSS对象存储"></a>OSS对象存储</h1><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ol>
<li>创建bucket</li>
<li>创建accessKey</li>
<li>查看快速文档</li>
</ol>
<p><img src="/2020/12/17/%E9%98%BF%E9%87%8C%E4%BA%91/aliyun/image-20201115182830089-1608895339419.png" alt="image-20201115182830089"></p>
<p><img src="/2020/12/17/%E9%98%BF%E9%87%8C%E4%BA%91/aliyun/image-20201115182848116-1608895339419.png" alt="image-20201115182848116"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Endpoint以杭州为例，其它Region请按实际情况填写。</span></span><br><span class="line">String endpoint = <span class="string">&quot;https://oss-cn-hangzhou.aliyuncs.com&quot;</span>;</span><br><span class="line"><span class="comment">// 阿里云主账号AccessKey拥有所有API的访问权限，风险很高。强烈建议您创建并使用RAM账号进行API访问或日常运维，请登录RAM控制台创建RAM账号。</span></span><br><span class="line">String accessKeyId = <span class="string">&quot;&lt;yourAccessKeyId&gt;&quot;</span>;</span><br><span class="line">String accessKeySecret = <span class="string">&quot;&lt;yourAccessKeySecret&gt;&quot;</span>;</span><br><span class="line">String bucketName = <span class="string">&quot;&lt;yourBucketName&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">OSS ossClient = <span class="keyword">new</span> OSSClientBuilder().build(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建存储空间。</span></span><br><span class="line">ossClient.createBucket(bucketName);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭OSSClient。</span></span><br><span class="line">ossClient.shutdown();            </span><br></pre></td></tr></table></figure>

<h2 id="pom文件"><a href="#pom文件" class="headerlink" title="pom文件"></a>pom文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--aliyun-oss--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.aliyun.oss&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;aliyun-sdk-oss&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.10.2&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- https:&#x2F;&#x2F;mvnrepository.com&#x2F;artifact&#x2F;joda-time&#x2F;joda-time --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;joda-time&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;joda-time&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.10.8&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="一些配置"><a href="#一些配置" class="headerlink" title="一些配置"></a>一些配置</h2><p><strong>当不需要数据源配置时，在启动类上面加上</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)</span></span><br></pre></td></tr></table></figure>

<p><strong>OSS常量配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.infantdemo.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Oss常量配置类</span></span><br><span class="line"><span class="comment"> *当项目已启动，spring接口，spring加载之后，执行接口一个方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 乐。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OSSPropertiesUtil</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;aliyun.oss.file.endpoint&#125;&quot;)</span></span><br><span class="line">    String endpoint;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;aliyun.oss.file.keyid&#125;&quot;)</span></span><br><span class="line">    String keyId;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;aliyun.oss.file.keysecret&#125;&quot;)</span></span><br><span class="line">    String keySecret;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;aliyun.oss.file.bucketname&#125;&quot;)</span></span><br><span class="line">    String bucketName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String END_POINT;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String KEY_ID;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String KEY_SECRET;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String BUCKET_NAME;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        END_POINT = endpoint;</span><br><span class="line">        KEY_ID = keyId;</span><br><span class="line">        KEY_SECRET = keySecret;</span><br><span class="line">        BUCKET_NAME = bucketName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="图片上传"><a href="#图片上传" class="headerlink" title="图片上传"></a><strong>图片上传</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">UploadFile</span><span class="params">(MultipartFile file)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        String endpoint = OSSPropertiesUtil.END_POINT;</span><br><span class="line"><span class="comment">// 云账号AccessKey有所有API访问权限，建议遵循阿里云安全最佳实践，创建并使用RAM子账号进行API访问或日常运维，请登录 https://ram.console.aliyun.com 创建。</span></span><br><span class="line">        String accessKeyId = OSSPropertiesUtil.KEY_ID;</span><br><span class="line">        String accessKeySecret = OSSPropertiesUtil.KEY_SECRET;</span><br><span class="line">        String bucketName = OSSPropertiesUtil.BUCKET_NAME;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">        OSS ossClient = <span class="keyword">new</span> OSSClientBuilder().build(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// 上传文件流。</span></span><br><span class="line">            InputStream inputStream = file.getInputStream();</span><br><span class="line">            String fileName = file.getOriginalFilename();</span><br><span class="line">            <span class="comment">//设置fileName名称不一致</span></span><br><span class="line">            fileName = UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>,<span class="string">&quot;&quot;</span>)+fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">            String filePath = <span class="keyword">new</span> DateTime().toString(<span class="string">&quot;yyyy/MM/dd&quot;</span>);</span><br><span class="line">            fileName = filePath+<span class="string">&quot;/&quot;</span>+fileName;</span><br><span class="line">            <span class="comment">//https://lz-upload-001.oss-cn-shenzhen.aliyuncs.com/16xx898466x0.jpg</span></span><br><span class="line">            String url = <span class="string">&quot;https://&quot;</span>+ bucketName+<span class="string">&quot;.&quot;</span>+endpoint+<span class="string">&quot;/&quot;</span>+fileName;</span><br><span class="line">            System.out.println(fileName);</span><br><span class="line">            ossClient.putObject(bucketName, fileName, inputStream);</span><br><span class="line">            <span class="keyword">return</span> url;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">// 关闭OSSClient。</span></span><br><span class="line">            ossClient.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="视频点播"><a href="#视频点播" class="headerlink" title="视频点播"></a>视频点播</h1><h2 id="阿里云-管理控制台"><a href="#阿里云-管理控制台" class="headerlink" title="阿里云 管理控制台"></a>阿里云 管理控制台</h2><p><img src="/2020/12/17/%E9%98%BF%E9%87%8C%E4%BA%91/aliyun/image-20201222210407226-1608895339420.png" alt="image-20201222210407226"></p>
<p><img src="/2020/12/17/%E9%98%BF%E9%87%8C%E4%BA%91/aliyun/image-20201222210427883.png" alt="image-20201222210427883"></p>
<h1 id="登录、注册"><a href="#登录、注册" class="headerlink" title="登录、注册"></a>登录、注册</h1><p><a target="_blank" rel="noopener" href="https://gitee.com/zjm1111/dashboard/projects">==谷粒在线教育代码gitee仓库==</a></p>
<h2 id="单点登录（sso-single-sign-on）三种常见的方式"><a href="#单点登录（sso-single-sign-on）三种常见的方式" class="headerlink" title="单点登录（sso single sign on）三种常见的方式"></a>单点登录（sso single sign on）三种常见的方式</h2><p><strong>session广播机制</strong>（不推荐使用）</p>
<p>​    session赋值</p>
<p><strong>使用cookie+redis实现</strong></p>
<p><strong>使用token 实现</strong></p>
<h2 id="短信验证码"><a href="#短信验证码" class="headerlink" title="短信验证码"></a>短信验证码</h2><h3 id="pom依赖"><a href="#pom依赖" class="headerlink" title="pom依赖"></a>pom依赖</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.aliyun&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;aliyun-java-sdk-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.5.3&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.75&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p><strong>申请模板管理与签名管理</strong></p>
<p><img src="/2020/12/17/%E9%98%BF%E9%87%8C%E4%BA%91/aliyun/image-20201223204532488.png" alt="image-20201223204532488"></p>
<p>==申请签名管理时，签名需要写的有点实际意义==</p>
<h2 id="微信二维码登录"><a href="#微信二维码登录" class="headerlink" title="微信二维码登录"></a>微信二维码登录</h2><p><strong>微信官方开放平台 :</strong></p>
<p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html">微信官方开放平台</a></p>
<p><strong>获取access_token时序图</strong></p>
<p><img src="/2020/12/17/%E9%98%BF%E9%87%8C%E4%BA%91/aliyun/D0wkkHSbtC6VUSHX4WsjP5ssg5mdnEmXO8NGVGF34dxS9N1WCcq6wvquR4K_Hcut" alt="img"></p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">wx.open.app-id</span>=<span class="string">#</span></span><br><span class="line"><span class="meta">wx.open.app-secret</span>=<span class="string">#</span></span><br><span class="line"><span class="meta">wx.redirect-url</span>=<span class="string">#</span></span><br></pre></td></tr></table></figure>

<p><strong>创建常量类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lz.aliyun;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Oss常量配置类</span></span><br><span class="line"><span class="comment"> * 当项目已启动，spring接口，spring加载之后，执行接口一个方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 乐。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantPropertiesUtil</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;aliyun.oss.file.endpoint&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String endpoint;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;aliyun.oss.file.key-id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String keyId;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;aliyun.oss.file.key-secret&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String keySecret;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;aliyun.oss.file.bucket-name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String bucketName;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;aliyun.duanxin.template-code&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String templateCode;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;wx.open.app-id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;wx.open.app-secret&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appSecret;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;wx.redirect-url&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String redirectUrl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String END_POINT;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String KEY_ID;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String KEY_SECRET;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String BUCKET_NAME;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String MESSAGE_TEMPLATE_CODE;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String APP_ID;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String APP_SECRET;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String REDIRECT_URL;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        END_POINT = endpoint;</span><br><span class="line">        KEY_ID = keyId;</span><br><span class="line">        KEY_SECRET = keySecret;</span><br><span class="line">        BUCKET_NAME = bucketName;</span><br><span class="line">        MESSAGE_TEMPLATE_CODE = templateCode;</span><br><span class="line">        APP_ID = appId;</span><br><span class="line">        APP_SECRET = appSecret;</span><br><span class="line">        REDIRECT_URL = redirectUrl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>创建Controller</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * 生成微信验证码用来登录</span><br><span class="line">     *</span><br><span class="line">     * @param response</span><br><span class="line">     * @return</span><br><span class="line">     * @throws IOException</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @GetMapping(&quot;&#x2F;login&quot;)</span><br><span class="line">    public String getCode(HttpServletResponse response) throws IOException &#123;</span><br><span class="line">        String baseUrl &#x3D; &quot;&quot;;</span><br><span class="line">        &#x2F;&#x2F;%s 相当于占位</span><br><span class="line">        baseUrl &#x3D; &quot;https:&#x2F;&#x2F;open.weixin.qq.com&#x2F;connect&#x2F;qrconnect&quot; +</span><br><span class="line">                &quot;?appid&#x3D;%s&quot; +</span><br><span class="line">                &quot;&amp;redirect_uri&#x3D;%s&quot; +</span><br><span class="line">                &quot;&amp;response_type&#x3D;code&quot; +</span><br><span class="line">                &quot;&amp;scope&#x3D;snsapi_login&quot; +</span><br><span class="line">                &quot;#wechat_redirect&quot;;</span><br><span class="line">        String redirectUrl &#x3D; ConstantPropertiesUtil.REDIRECT_URL;</span><br><span class="line">        try &#123;</span><br><span class="line">            redirectUrl &#x3D; URLEncoder.encode(redirectUrl, &quot;UTF-8&quot;);</span><br><span class="line">        &#125; catch (UnsupportedEncodingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        String url &#x3D; String.format(</span><br><span class="line">                baseUrl</span><br><span class="line">                , ConstantPropertiesUtil.APP_ID</span><br><span class="line">                , redirectUrl</span><br><span class="line">        );</span><br><span class="line">        return &quot;redirect:&quot; + url;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>获取用户信息</strong></p>
<p>==准备工作==</p>
<h3 id="pom依赖-1"><a href="#pom依赖-1" class="headerlink" title="pom依赖"></a>pom依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--httpclient--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--commons-io--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!--gson--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>1、</strong>全局配置的跳转路径   微信开放平台 重定向url</p>
<p><strong>2</strong> wx.open.redirect_url=</p>
<p>http://回调地址/api/ucenter/wx/callback</p>
<p>修改当前项目启动端口号为<strong>8150</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/callback&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">callback</span><span class="params">(String code)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*https://api.weixin.qq.com/sns/oauth2/access_token?appid=APPID&amp;secret=SECRET&amp;code=CODE&amp;grant_type=authorization_code*/</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取access_token</span></span><br><span class="line">            String baseUrl = <span class="string">&quot;https://api.weixin.qq.com/sns/oauth2/access_token&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;?appid=%s&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&amp;secret=%s&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&amp;code=%s&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;&amp;grant_type=authorization_code&quot;</span>;</span><br><span class="line">            String accessTokenUrl = String.format(</span><br><span class="line">                    baseUrl,</span><br><span class="line">                    ConstantPropertiesUtil.APP_ID,</span><br><span class="line">                    ConstantPropertiesUtil.APP_SECRET,</span><br><span class="line">                    code</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">//根据AppId、AppSecret以及code获取access_token以及openId</span></span><br><span class="line">            String res = HttpClientUtils.get(accessTokenUrl);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//转化成json对象获取数据</span></span><br><span class="line">            Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">            HashMap accessTokenMap = gson.fromJson(res, HashMap.class);</span><br><span class="line">            String access_token = (String) accessTokenMap.get(<span class="string">&quot;access_token&quot;</span>);</span><br><span class="line">            String openid = (String) accessTokenMap.get(<span class="string">&quot;openid&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//从数据库里面判断该用户是否已存在</span></span><br><span class="line"><span class="comment">//            if(true)&#123;           //用户不存在</span></span><br><span class="line">                <span class="comment">//获取用户信息</span></span><br><span class="line">                String baseUserInfoUrl = <span class="string">&quot;https://api.weixin.qq.com/sns/userinfo&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;?access_token=%s&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&amp;openid=%s&quot;</span>;</span><br><span class="line">                String userInfoUrl = String.format(</span><br><span class="line">                        baseUserInfoUrl,</span><br><span class="line">                        access_token,</span><br><span class="line">                        openid</span><br><span class="line">                );</span><br><span class="line">                String userInfo = HttpClientUtils.get(userInfoUrl);</span><br><span class="line">                HashMap userInfoMap = gson.fromJson(userInfo, HashMap.class);</span><br><span class="line">                String nickname = (String) userInfoMap.get(<span class="string">&quot;nickname&quot;</span>);</span><br><span class="line">                String headImgUrl = (String) userInfoMap.get(<span class="string">&quot;headimgurl&quot;</span>);</span><br><span class="line">                String openId = (String) userInfoMap.get(<span class="string">&quot;openid&quot;</span>);</span><br><span class="line">                <span class="comment">//将用户信息存入数据库;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">            String token = JwtUtil.sign(openId, nickname);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;token: &quot;</span>+token;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LZ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LZ</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
